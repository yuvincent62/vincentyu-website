<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Project</title>
  <link rel="stylesheet" href="stylefile.css">
  <link rel="stylesheet" href="chart.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
</head>

<body>
  <div id="map"></div>

  <div class="explanation" id="explanation" aria-live="polite">Explanation goes here</div>

  <div id="topCanvas"></div>
  <div id="returnCanvas">
    <div class="buttonContainer">
      <button id="returnButton" class="buttonTop">Reset</button>
    </div>
  </div>
  <div id="canvasContainer4">
    <div id="canvas4">
      <div class="top-buttons">
        <div class="button-container">
          <button class="chart-parameter" id="button41"></button>
          <span class="label">CO2</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button42"></button>
          <span class="label">PM2.5</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button43"></button>
          <span class="label">Dew Point</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button44"></button>
          <span class="label">TVOC</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button45"></button>
          <span class="label">TEMP</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button46"></button>
          <span class="label">RH</span>
        </div>
      </div>
      <canvas id="curveCanvas" width="800" height="400"></canvas>
      <div class="chart-buttons">
        <div class="button-container">
          <button class="chart-date" id="hour"></button>
          <span class="label">Hour</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="day"></button>
          <span class="label">Day</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="week"></button>
          <span class="label">Week</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="month"></button>
          <span class="label">Month</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="year"></button>
          <span class="label">Year</span>
        </div>
      </div>
    </div>
    <div id="buttonContainer">
      <div id="closeButton">Return to Map</div>
      <div id="getCSVButton">Get CSV</div>
    </div>
  </div>
  <div id="bottomCanvas">
    <div class="bottomButtonContainer">
      <button id="btn1" class="button buttonBottom"></button><span class="bottomButtonText">CO2</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn2" class="button buttonBottom"></button><span class="bottomButtonText">PM2.5</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn3" class="button buttonBottom"></button><span class="bottomButtonText">Dew Point</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn4" class="button buttonBottom"></button><span class="bottomButtonText">TVOC</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn5" class="button buttonBottom"></button><span class="bottomButtonText">Temperature</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn6" class="button buttonBottom"></button><span class="bottomButtonText">Relative Humidity</span>
    </div>
  </div>
  <div id="overlay"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZ9erro9k6fImEbGmGdGjLxf2kFdPC4lI"></script>

  <script> 

class classSensor {
  constructor(name, color, width, height, lat, lng, text, number, borderRadius = "0") {
      this.name = name;
      this.color = color;
      this.width = width;
      this.height = height;
      this.lat = lat;
      this.lng = lng;
      this.text = text;
      this.number = this.createMarkerNumber(number);
      this.borderRadius = borderRadius; // New property for borderRadius
      this.icon = this.createColoredIcon(map.getZoom()); // Initialize icon using createColoredIcon method
      this.marker = L.marker([lat, lng], { icon: this.icon, zIndexOffset: 100 }).addTo(map);
      this.marker.bindPopup(`<b>${this.name}</b>`);
      this.showCanvas4 = this.showCanvas4.bind(this);
      this.marker.on('click', () => this.showCanvas4(name)); // Pass the room name
      this.marker.on('mouseover', () => this.showNumberPopup());
      this.marker.on('mouseout', () => this.hideNumberPopup());
      
      // Bind the adjustFontSize method to zoomend and moveend events
      map.on('zoomend moveend', () => this.updateIcon());
  }

  calculateFontSize(zoomLevel) {
      const baseSize = 22; // Base font size
      const scaleFactor = 1.6; // Scaling factor for each zoom level
      return baseSize * Math.pow(scaleFactor, zoomLevel - 20.5);
  }

  createColoredIcon(zoomLevel) {
      const { color, width, height, text, borderRadius } = this;
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');

      // Draw rounded rectangle with border
      ctx.fillStyle = color;
      ctx.strokeStyle = 'black';
      ctx.lineWidth = 3;

      // Draw rounded rectangle
      const cornerRadius = parseFloat(borderRadius); // Convert borderRadius to a float number
      ctx.beginPath();
      ctx.moveTo(cornerRadius, 0);
      ctx.lineTo(width - cornerRadius, 0);
      ctx.quadraticCurveTo(width, 0, width, cornerRadius);
      ctx.lineTo(width, height - cornerRadius);
      ctx.quadraticCurveTo(width, height, width - cornerRadius, height);
      ctx.lineTo(cornerRadius, height);
      ctx.quadraticCurveTo(0, height, 0, height - cornerRadius);
      ctx.lineTo(0, cornerRadius);
      ctx.quadraticCurveTo(0, 0, cornerRadius, 0);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // Draw text in the center with dynamic font size
      const fontSize = this.calculateFontSize(zoomLevel);
      ctx.font = `${fontSize}px Arial`;
      ctx.fillStyle = 'black';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(text, width / 2, height / 2);

      // Return L.icon object with canvas image data
      return L.icon({
          iconUrl: canvas.toDataURL(),
          iconSize: [width, height],
          iconAnchor: [width / 2, height / 2]
      });
  }

  createMarkerNumber(number) {
      const markerNumber = document.createElement('div');
      markerNumber.className = 'marker-number';
      markerNumber.innerText = number;
      return markerNumber;
  }

  updateIcon() {
      const zoomLevel = map.getZoom();
      this.icon = this.createColoredIcon(zoomLevel);
      this.marker.setIcon(this.icon);
  }

  // Other methods remain unchanged
  updateColor(newColor) {
      this.color = newColor;
      this.updateIcon();
  }

  showCanvas4(roomName) {
      activeRoomName = roomName; // Set the active room name
      document.getElementById('canvasContainer4').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';

      // Trigger clicks on button43 and Day
      document.getElementById('button43').click();
      document.getElementById('day').click();
  }

  showNumberPopup() {
      if (this.marker.options.opacity === 1) {
          this.marker.bindPopup(`<b>${this.number.innerText}</b>`).openPopup();
      }
  }

  hideNumberPopup() {
      this.marker.closePopup();
  }

  hideMarker() {
      this.marker.setOpacity(0);
      this.marker.unbindPopup();
  }

  showMarker() {
      this.marker.setOpacity(1);
      this.marker.bindPopup(`<b>${this.name}</b>`);
  }
}  
  
function defineAndDisplayRoomMarkers(school, floor, parameter) {
  clearRoomMarkers();

  const bottomOption = activeBottomButtonText;
  const valueArrayIn = SetValueArray(school, floor, bottomOption);
  let valueArray = valueArrayIn.map(num => parseFloat(num.toFixed(1)));

  let suffix = '';
  let prefix = '';
  if (parameter === 'CO2') {
      prefix = 'CO2: ';
      suffix = 'ppm';
  } else if (parameter === 'PM2.5') {
      prefix = 'PM2.5: ';
      suffix = 'µg/m\u00B3';
  } else if (parameter === 'Dew Point') {
      prefix = 'Dew Point: ';
      suffix = '\u00B0F';
  } else if (parameter === 'TVOC') {
      prefix = 'TVOC: ';
      suffix = 'µg/m\u00B3';
  } else if (parameter === 'Relative Humidity') {
      prefix = 'RH: ';
      suffix = '%';
  } else if (parameter === 'Temperature') {
      prefix = 'Temp: ';
      suffix = '\u00B0F';
  }

  function setScallor(){
    const zoom= map.getZoom();
    return Math.pow(2, zoom - 20.5); 
  }

  function addClassToAllButtons(className) {
    const buttons = document.querySelectorAll('button');
    buttons.forEach(button => {
      button.classList.add(className);
    });
  }
  
  function addRoomMarker(name, color, width, height, lat, lng, text, number, borderRadius) {
    var roomMarker = new classSensor(name, color, width, height, lat, lng, text, number, borderRadius);
    roomMarkers.push(roomMarker);
    // Call the function to add the class after adding the room marker
    addClassToAllButtons('classRoom');
  }
  
  const scaleFactor = setScallor();
  
  function addModifiedRoomMarker(room, color, width, height, lat, lng, code, value, borderRadius) {
    // Adjust width and height based on the scale factor if necessary
    const adjustedWidth = width * scaleFactor;
    const adjustedHeight = height * scaleFactor;
    let adjustedborderRadius;
    if (borderRadius) {
      adjustedborderRadius = borderRadius * scaleFactor;
    } else {
      adjustedborderRadius = 0;
    }
    addRoomMarker(room, color, adjustedWidth, adjustedHeight, lat, lng, code, prefix + value + suffix, adjustedborderRadius);
  }

  if (school === 1) {
      if (floor === 'Ground') {
          addModifiedRoomMarker('Room 111', 'black', 60, 60, 41.877425, -87.75188, 'G14', valueArray[0]);
          addModifiedRoomMarker('Room 112', 'black', 180, 32, 41.8772905, -87.7517385, 'Admin Hall', valueArray[1]);
          addModifiedRoomMarker('Room 113', 'black', 165, 200, 41.87721, -87.75148, 'G26', valueArray[2]);
          addModifiedRoomMarker('Room 114', 'black', 140, 240, 41.8771875, -87.751719, 'G33', valueArray[3]);
      } else if (floor === 'First') {
          addModifiedRoomMarker('Room 121', 'black', 120, 95, 41.87721, -87.75238, '115', valueArray[0]);
          addModifiedRoomMarker('Room 122', 'black', 110, 100, 41.877435, -87.751698, '134', valueArray[1]);
          addModifiedRoomMarker('Room 123', 'black', 110, 100, 41.877435, -87.751588, '135', valueArray[2]);
          addModifiedRoomMarker('Room 124', 'black', 110, 100, 41.877435, -87.75148, '136', valueArray[3]);
          addModifiedRoomMarker('Room 125', 'black', 110, 100, 41.877311, -87.751842, '137', valueArray[4]);
          addModifiedRoomMarker('Room 126', 'black', 110, 100, 41.877311, -87.751735, '138', valueArray[5]);
          addModifiedRoomMarker('Room 127', 'black', 125, 110, 41.87725, -87.75146, '141', valueArray[6]);
          addModifiedRoomMarker('Room 128', 'black', 100, 75, 41.877241, -87.751612, '142', valueArray[7]);
          addModifiedRoomMarker('Room 129', 'black', 275, 380, 41.877081, -87.75153, '143', valueArray[8]);
      } else if (floor === 'Second') {
          addModifiedRoomMarker('Room 131', 'black', 110, 100, 41.87721, -87.75225, '210', valueArray[0]);
          addModifiedRoomMarker('Room 132', 'black', 110, 100, 41.877435, -87.751698, '231', valueArray[1]);
          addModifiedRoomMarker('Room 133', 'black', 110, 100, 41.877435, -87.751588, '232', valueArray[2]);
          addModifiedRoomMarker('Room 134', 'black', 110, 100, 41.877435, -87.75148, '233', valueArray[3]);
          addModifiedRoomMarker('Room 135', 'black', 110, 100, 41.877311, -87.751815, '234', valueArray[4]);
          addModifiedRoomMarker('Room 136', 'black', 110, 100, 41.877311, -87.751708, '235', valueArray[5]);
          addModifiedRoomMarker('Room 137', 'black', 110, 100, 41.877311, -87.75149, '236', valueArray[6]);
      }
  } else if (school === 2) {
    if (floor === 'Floor29') {
          addModifiedRoomMarker('Room 211', 'red', 140, 100, 41.88641, -87.62757, 'A', valueArray[0]);
          addModifiedRoomMarker('Room 212', 'red', 100, 140, 41.886377, -87.62770, 'B', valueArray[1]);
          addModifiedRoomMarker('Room 213', 'red', 100, 130, 41.88638, -87.62735, 'C', valueArray[2]);
          addModifiedRoomMarker('Room 214', 'red', 120, 110, 41.88659, -87.62744, 'D', valueArray[3]);
      } else if (floor === 'Floor30') {
          addModifiedRoomMarker('Room 221', 'red', 100, 150, 41.88659, -87.62770, 'A', valueArray[0]);
          addModifiedRoomMarker('Room 222', 'red', 150, 100, 41.88641, -87.62757, 'B', valueArray[1]);
          addModifiedRoomMarker('Room 223', 'red', 100, 145, 41.88649, -87.62740, 'C', valueArray[2]);
      }else if (floor === 'Floor31') {
        addModifiedRoomMarker('Room 231', 'red',  150, 90, 41.88645, -87.62754, 'A', valueArray[0]);
        addModifiedRoomMarker('Room 232', 'red', 100, 140, 41.886377, -87.62770, 'B', valueArray[1]);
        addModifiedRoomMarker('Room 232', 'red', 115, 150, 41.88660, -87.627693, 'C', valueArray[2]);
    }
  } else if (school === 3){
    addModifiedRoomMarker('Room 311', 'black', 120, 120, 43.20875, -89.19757, 'A', valueArray[0], 76);
    addModifiedRoomMarker('Room 311', 'black', 120, 120, 43.20867, -89.197553, 'B', valueArray[1], 76);
    addModifiedRoomMarker('Room 311', 'black', 120, 120, 43.20859, -89.197537, 'C', valueArray[2], 76);
    addModifiedRoomMarker('Room 311', 'black', 120, 120, 43.20851, -89.197523, 'D', valueArray[3], 76);
    addModifiedRoomMarker('Room 311', 'black', 120, 120, 43.20843, -89.197507, 'E', valueArray[4], 76);
    addModifiedRoomMarker('Room 311', 'black', 120, 120, 43.20825, -89.197485, 'F', valueArray[5], 76);
    addModifiedRoomMarker('Room 311', 'black', 120, 120, 43.20809, -89.19746, 'G', valueArray[6], 76);
    addModifiedRoomMarker('Room 311', 'black', 100, 100, 43.20798, -89.197430, 'H', valueArray[7], 65);

  }
}




    // Define global variables to store the arrays
    let quarraArray = [];
    let CJAArray = [];
    let shoreArray = [];
    let quarraStatus = [];
    let CJAStatus = [];
    let shoreStatus = [];
    let quarraOnlinePercent = 0;
    let CJAOnlinePercent = 0;
    let shoreOnlinePercent = 0;
    let chart;
    let accessToken;
    let cArray1 = [];
    let cArray2 = [];
    let cArray3 = [];   
    let sArray1 = [];
    let sArray2 = [];
    let sArray3 = [];     
    
    async function requestAccessToken() {
      const clientId = "broan-ciaq-conclusiveinsights.client.bdbs80lebnaapu5avm4capd0zcphsyn2";
      const clientSecret = "gn136a3mx5mly0ves9cvsfw38ooucl7k96ueo85z79xs4pikaqqmv2l6w8ccwfpk";

      const credentials = `${clientId}:${clientSecret}`;
      const encodedCredentials = btoa(credentials);

      const myHeaders = new Headers();
      myHeaders.append("Authorization", `Basic ${encodedCredentials}`);

      const requestOptions = {
        method: "POST",
        headers: myHeaders,
        redirect: "follow"
      };

      const grantType = "client_credentials";
      const url = `https://nkh3da6ksg.execute-api.us-east-1.amazonaws.com/v1/accesstoken?grant_type=${grantType}`;

      try {
        const response = await fetch(url, requestOptions);
        const result = await response.json();
        accessToken = result.access_token;
      } catch (error) {
        console.error(error);
      }
    }

    const myHeaders = new Headers();
    myHeaders.append("x-api-key", "i9Pax1ZLPH5uRilqKOmWY3TB2TbhSqQH86c78VaS");

    async function fetchData() {
      try {      
        await requestAccessToken();
        myHeaders.append("Authorization", `Bearer ${accessToken}`);
        const requestOptions = {
          method: "GET",
          headers: myHeaders,
          redirect: "follow"
        };
        const response = await fetch("https://nylc1ow0ih.execute-api.us-east-1.amazonaws.com/v1/partner/user/tdemonte@madisoniaq.com/home/details", requestOptions);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const rawData = await response.json();
        return rawData;
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    // Function to calculate dew point using the Magnus-Tetens formula
    function calculateDewPointCelsius(temperatureC, humidity) {
        const a = 17.27;
        const b = 237.7;
        const alpha = ((a * temperatureC) / (b + temperatureC)) + Math.log(humidity / 100);
        const dewPointC = (b * alpha) / (a - alpha);
        return dewPointC;
    }

    // Function to convert Celsius to Fahrenheit
    function celsiusToFahrenheit(celsius) {
        return celsius * 9 / 5 + 32;
    }

    // Function to process the devices for a specific home name
    function processDevices(homeName, rawData) {
        const homeData = rawData.find(item => item.homeName === homeName);
        if (homeData) {
            return homeData.rooms.flatMap(room => {
                return room.devices.map(device => {
                    const { deviceId, deviceName, deviceStatus, co2, pm25, tvoc, temperature, humidity } = device;
                    const dewPointC = calculateDewPointCelsius(temperature, humidity);
                    const dewPointF = parseFloat(celsiusToFahrenheit(dewPointC).toFixed(1));
                    const temperatureF = parseFloat(celsiusToFahrenheit(temperature).toFixed(1));
                    return [co2, pm25, dewPointF, tvoc, temperatureF, humidity, deviceName, deviceStatus];
                });
            });
        } else {
            console.log(`Home ${homeName} not found in raw data.`);
            return [];
        }
    }

    // Desired order for quarraArray
    const qdesiredOrder = [
        "Plant 2 - Sensor A",
        "Plant 2 - Sensor B",
        "Plant 2 - Sensor C",
        "Plant 2 - Sensor D",
        "Plant 2 - Sensor E",
        "Plant 2 - Sensor F",
        "Plant 2 - Sensor G",
        "Plant 2 - Sensor H",
        "1",
        "Plant 2"
    ];

    // Desired order for CJAArray
    const cdesiredOrder = [
        "G14",
        "Admin Hall G21/G22",
      	"Cafeteria East",
        "G33",
        "115",
      	"111",
        "135",
        "136",
        "137",
        "138",
        "141",
        "142",
        "Gym Sensor East",
        "210",
        "231",
        "232",
        "233",
        "234",
        "235",
        "236",
    ];

    // Desired order for ChoreArray
    const sdesiredOrder = [
        "Level 1 Sensor A",
        "Level 1 Sensor B",
        "Level 1 Sensor C",
        "Level 1 Sensor D",
        "Level 2 Sensor A",
        "Level 2 Sensor B",
        "Level 2 Sensor C",
        "Level 3 Sensor A",
        "Level 3 Sensor B",
        "Level 3 Sensor C"
    ];    

    // Function to sort array based on desired order
    function sortArrayByOrder(array, order) {
        const orderMap = new Map(order.map((name, index) => [name, index]));
        
        const sortedArray = array.slice().sort((a, b) => {
            const nameA = a[6];
            const nameB = b[6];
            const posA = orderMap.has(nameA) ? orderMap.get(nameA) : order.length;
            const posB = orderMap.has(nameB) ? orderMap.get(nameB) : order.length;
            return posA - posB;
        });

        return sortedArray;
    }

    // Function to calculate the percentage of "Online" statuses in an array
    function calculateOnlinePercent(statusArray) {
        if (statusArray.length === 0) {
            console.log('The array is empty.');
            return 0;
        }

        let onlineCount = 0;
        let offlineCount = 0;

        for (let status of statusArray) {
            if (status === "Online") {
                onlineCount++;
            } else {
                offlineCount++;
            }
        }

        const onlinePercent = (onlineCount / statusArray.length) * 100;
        return onlinePercent;
    }

    // Function to handle option changes
    function onOptionChange(prop, value) {
      if (prop === 'topOption') {
        defineAndDisplayRoomMarkers(schoolSelection, value, activeBottomButtonText);
      } else if (prop === 'bottomOption') {
        defineAndDisplayRoomMarkers(schoolSelection, options.topOption, activeBottomButtonText);
      }
    }

    // Function to update marker colors
    function updateMarkerColors(colorArray) {
      var visibleMarkers = roomMarkers.filter(function (room) {
        return room.marker.options.opacity === 1;
      });

      visibleMarkers.forEach(function (room, index) {
        if (index < colorArray.length) {
          room.updateColor(colorArray[index]);
        }
      });
    }

    // Call the fetchData function and process the data initially
    fetchData().then(rawData => {
        if (rawData) {
            quarraArray = processDevices("Quarra Stone", rawData);
            quarraArray = sortArrayByOrder(quarraArray, qdesiredOrder);

            CJAArray = processDevices("CJA", rawData);
            CJAArray = sortArrayByOrder(CJAArray, cdesiredOrder);
            cArray1 = CJAArray.slice(0,4);
            cArray2 = CJAArray.slice(4,13);
            cArray3 = CJAArray.slice(13,20);
            shoreArray = processDevices("Shore Capital Partners", rawData);
            shoreArray = sortArrayByOrder(shoreArray, sdesiredOrder);
            sArray1 = shoreArray.slice(0,4);
            sArray2 = shoreArray.slice(4,7);
            sArray3 = shoreArray.slice(7,10);
            quarraStatus = quarraArray.map(device => device[7]);
            CJAStatus = CJAArray.map(device => device[7]);
            shoreStatus = shoreArray.map(device => device[7]);   
            quarraOnlinePercent = calculateOnlinePercent(quarraStatus);
            CJAOnlinePercent = calculateOnlinePercent(CJAStatus);
            shoreOnlinePercent = calculateOnlinePercent(shoreStatus);

            initMap(quarraOnlinePercent, CJAOnlinePercent, shoreOnlinePercent);
        }
    });

    function initMap(quarraOnlinePercent, CJAOnlinePercent, shoreOnlinePercent) {
      var options = {
          center: initialMapCenter,
          zoom: initialMapZoom,
          maxZoom: setMaxZoom(),
          zoomDelta: 2,
          wheelPxPerZoomLevel: 50,
          scrollWheelZoom: false,
          dragging: false,
          touchZoom: false,
          doubleClickZoom: false
      };

      map = L.map('map', options);

      var roadMapLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 19.5,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: 'Map data &copy; Google'
      });

      var satelliteMapLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 19.5,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: 'Map data &copy; Google'
      }).addTo(map);

      var baseMaps = {
        "Road Map": roadMapLayer,
        "Satellite View": satelliteMapLayer
      };

      var layerControl = L.control.layers(baseMaps, null, {
        position: 'topleft'
      }).addTo(map);

      var pieData1 = [
        { color: 'green', percentage: CJAOnlinePercent },
        { color: 'black', percentage: 100-CJAOnlinePercent }
      ];

      var pieData2 = [
        { color: 'green', percentage: shoreOnlinePercent },
        { color: 'black', percentage: 100 - shoreOnlinePercent}
      ];

      var pieData3 = [
        { color: 'green', percentage: quarraOnlinePercent },
        { color: 'black', percentage: 100-quarraOnlinePercent }
      ];

      const marker1 = L.marker([41.877331, -87.751678], { icon: createPiechartIcon(pieData1, 40, "20"), name: "Chicago Jesuit Academy", zIndexOffset: 1000 }).addTo(map);
      marker1.bindPopup("<b>Chicago Jesuit Academy</b>");
      markerArray.push(marker1);

      marker1.on('click', function (e) {
        var lng = e.latlng.lng;
        var lat = e.latlng.lat;
        onMarkerClick(lat, lng);
      });

      const marker2 = L.marker([41.88654, -87.62754], { icon: createPiechartIcon(pieData2, 40, "10"), name: "Shore Capital Partners", zIndexOffset: 1000 }).addTo(map);
      marker2.bindPopup("<b>Shore Capital Partners</b>");
      markerArray.push(marker2);

      marker2.on('click', function (e) {
        var lng = e.latlng.lng;
        var lat = e.latlng.lat;
        onMarkerClick(lat, lng);
      });

      const marker3 = L.marker([43.2084038, -89.1974613], { icon: createPiechartIcon(pieData3, 40, "8"), name: "Quarra Stone", zIndexOffset: 1000 }).addTo(map);
      marker3.bindPopup("<b>Quarra Stone</b>");
      markerArray.push(marker3);

      marker3.on('click', function (e) {
        var lng = e.latlng.lng;
        var lat = e.latlng.lat;
        onMarkerClick(lat, lng);
      });

      markerArray.forEach(function (marker) {
        marker.on('mouseover', function () {
          if (this.options.opacity === 1) {
            this.openPopup();
          }
        });

        marker.on('mouseout', function () {
          this.closePopup();
        });
      });

      map.on('moveend', function () {
        updateVisibleMarkers();
      });

      map.on('zoomend', function () {
        updateVisibleMarkers();
        if (map.getZoom() >= 19.5) {
          layerControl._container.style.pointerEvents = 'none';
          layerControl._container.style.opacity = '0.5';
        } else {
          layerControl._container.style.pointerEvents = 'auto';
          layerControl._container.style.opacity = '1';
        }
      });

      map.on('load', function () {
        map.scrollWheelZoom.enable();
        map.dragging.enable();
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
      });

      map.whenReady(function () {
        map.scrollWheelZoom.enable();
        map.dragging.enable();
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
      });

      updateVisibleMarkers();

      activateButton(document.getElementById('btn3').parentElement.querySelector('.button'), 'bottomCanvas');

      document.getElementById('returnButton').addEventListener('click', returnToInitialMapView);

      updateExplanation('option1');
    }

    function hideCanvas(canvasId) {
      var canvas = document.getElementById(canvasId);
      if (canvas) {
        canvas.style.display = 'none';
      }
    }

    function showCanvas(canvasId) {
      var canvas = document.getElementById(canvasId);
      if (canvas) {
        canvas.style.display = 'flex';
        if (canvasId === 'bottomCanvas') {
          canvas.style.flexDirection = 'column';
        }
      }
    }

    document.getElementById('topCanvas').addEventListener('click', function (event) {
      if (event.target && event.target.matches('.buttonTop')) {
        clearRoomMarkers();
        activateButton(event.target, 'topCanvas');
      }
    });

    document.getElementById('bottomCanvas').addEventListener('click', function (event) {
      if (event.target && event.target.matches('.buttonBottom')) {
        activateButton(event.target, 'bottomCanvas');
      }
    });

    function onMarkerClick(lat, lng) {
      map.setView([lat, lng], map.getMaxZoom() - 2);
      drawCurve();  // Ensure drawCurve is called here
    }

    function hideCanvas4() {
      document.getElementById('canvasContainer4').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    document.getElementById('closeButton').onclick = hideCanvas4;

    document.getElementById('getCSVButton').addEventListener('click', generateAndDownloadCSV);

    function generateAndDownloadCSV() {
      const data = array13;
      const csvContent = data.map(e => e.join(",")).join("\n");

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

      const link = document.createElement("a");
      if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", "data.csv");
          
          document.body.appendChild(link);
          link.click();
          
          document.body.removeChild(link);
      }
    }

    let zoomLevel = false;
    let schoolSelection = null;
    let map;
    let markerArray = [];
    let roomMarkers = [];
    let activeTopButtonId = 'top1';
    let activeBottomButtonText = 'Dew Point';
    const initialMapCenter = [43.0731, -89.4012];
    const initialMapZoom = 8;
    let activeChartParameter = 'CO2';
    let activeChartDate = 'hour';
    let activeRoomName = '';
    let options = {
      topOption: 'Ground',
      bottomOption: 'Dew Point'
    };

    function updateVisibleMarkers() {
      var visibleMarkers = markerArray.filter(function (marker) {
        return map.getBounds().contains(marker.getLatLng());
      });

      var zoomLevel = map.getZoom() >= 18;
      const arrayLength = markerArray.length;

      if (zoomLevel) {
        var schoolPass = null;
        if (visibleMarkers.length === 1) {
          schoolPass = visibleMarkers[0].options.name;
        }

        if (schoolPass === 'Chicago Jesuit Academy') {
          schoolSelection = 1;
        } else if (schoolPass === 'Shore Capital Partners') {
          schoolSelection = 2;
        } else if (schoolPass === 'Quarra Stone') {
          schoolSelection = 3;
        }
        else {
          schoolSelection = null;
        }

        if (schoolSelection !== null) {
          createTopCanvasButtons(schoolSelection);
        }

        for (let i = 0; i < arrayLength; i++) {
          markerArray[i].setOpacity(0);
          markerArray[i].closePopup();
          markerArray[i].unbindPopup();
        }
        showCanvas('topCanvas');
        showCanvas('bottomCanvas');
        showCanvas('explanation');
        defineAndDisplayRoomMarkers(schoolSelection, options.topOption);

        var firstTopButton = document.querySelector('#topCanvas .buttonTop');
        if (firstTopButton) {
          firstTopButton.click();
        }

        var thirdBottomButton = document.querySelectorAll('#bottomCanvas .buttonBottom')[2];
        if (thirdBottomButton) {
          thirdBottomButton.click();
        }
      } else {
        for (let i = 0; i < arrayLength; i++) {
          markerArray[i].setOpacity(1);
          markerArray[i].bindPopup(`<b>${markerArray[i].options.name}</b>`);
        }
        hideCanvas('topCanvas');
        hideCanvas('bottomCanvas');
        hideCanvas('explanation');
        clearRoomMarkers();
      }
    }

    function clearRoomMarkers() {
      roomMarkers.forEach(function (roomMarker) {
        map.removeLayer(roomMarker.marker);
      });
      roomMarkers = [];
    }

    function activateButton(button, canvasId) {
      var canvasType = canvasId === 'topCanvas' ? 'topOption' : 'bottomOption';

      var buttons = document.querySelectorAll('#' + canvasId + ' .buttonTop, #' + canvasId + ' .buttonBottom');
      buttons.forEach(function (btn) {
        btn.classList.remove('active');
        btn.style.backgroundColor = "white";
        btn.style.color = "black";
      });

      button.classList.add('active');
      button.style.backgroundColor = "green";
      button.style.color = "white";

      options[canvasType] = button.nextElementSibling.textContent.trim();

      if (canvasId === 'topCanvas') {
        activeTopButtonId = button.id;
      } else if (canvasId === 'bottomCanvas') {
        activeBottomButtonText = button.nextElementSibling.textContent.trim();
      }

      onOptionChange(canvasType, options[canvasType]);

      const currentSchool = schoolSelection;
      const currentFloor = options.topOption;
      const currentParameter = activeBottomButtonText;
      let colorArray = [];
      zoomLevel = (map.getZoom()>=18);    
      if (zoomLevel) {
        colorArray = SetColorArray(currentSchool, currentFloor, currentParameter);
      }
      updateMarkerColors(colorArray);
    }

    function createTopCanvasButtons(school) {
      var topCanvas = document.getElementById('topCanvas');
      topCanvas.innerHTML = '';
    
      var buttonNames;
      if (school === 1) {
        buttonNames = ['Ground', 'First', 'Second'];
      } else if(school === 2){
        buttonNames = ['Floor29', 'Floor30', 'Floor31'];
      } else if(school === 3){
          buttonNames = ['null'];
      }
      if ( buttonNames!='null'){
        buttonNames.forEach(function (name, index) {
          var buttonContainer = document.createElement('div');
          buttonContainer.className = 'buttonContainer';
          var button = document.createElement('button');
          button.id = 'top' + (index + 1);
          button.className = 'buttonTop';
          button.onclick = function () { activateButton(this, 'topCanvas'); };
          var span = document.createElement('span');
          span.className = 'buttonText';
          span.textContent = name;
          buttonContainer.appendChild(button);
          buttonContainer.appendChild(span);
          topCanvas.appendChild(buttonContainer);
        });
        var firstButton = topCanvas.querySelector('.buttonTop');
        if (firstButton) {
          activateButton(firstButton, 'topCanvas');
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      var initialMapCenter = [43.0731, -89.4012];
      var initialMapZoom = 8;
  
      function returnToInitialMapView() {
        map.setView(initialMapCenter, initialMapZoom);
      }
  
      document.getElementById('returnButton').addEventListener('click', returnToInitialMapView);
    });
  
    function createPiechartIcon(data, size, text) {
  function percentageToAngle(percentage) {
    return (percentage / 100) * 360;
  }

  function describeArc(x, y, radius, startAngle, endAngle) {
    var start = polarToCartesian(x, y, radius, endAngle);
    var end = polarToCartesian(x, y, radius, startAngle);
    var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

    var d = [
      "M", x, y,
      "L", start.x, start.y,
      "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
      "Z"
    ].join(" ");
    return d;
  }

  function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
    var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
    return {
      x: centerX + (radius * Math.cos(angleInRadians)),
      y: centerY + (radius * Math.sin(angleInRadians))
    };
  }

  var startAngle = 0;
  var paths = data.map(function(segment) {
    var percentage = segment.percentage;
    if (percentage === 100) {
      percentage = 99.999; // Slightly reduce the percentage to avoid full circle rendering issue
    }
    var endAngle = startAngle + percentageToAngle(percentage);
    var path = describeArc(16, 16, 16, startAngle, endAngle);
    startAngle = endAngle;
    return `<path d="${path}" fill="${segment.color}"/>`;
  }).join("");

  var svg = `
    <svg width="${size}" height="${size}" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
      ${paths}
      <circle cx="16" cy="16" r="10" fill="white"/>
      <text x="16" y="21" font-size="10" text-anchor="middle" fill="#000">${text}</text>
    </svg>`;
  var url = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svg)));
  return new L.Icon({
    iconUrl: url,
    iconSize: [size, size],
    iconAnchor: [size / 2, size / 2],
    popupAnchor: [0, -size / 2]
  });
}


    function setMaxZoom() {
      var viewportHeight = window.innerHeight;
      var manuMax = 19.5; // Add this line to define manuMax
      currentMaxZoom = viewportHeight < 550 ? manuMax : 19.5;
      return currentMaxZoom;
    }

    //generate data
    function getRandomNumber(min, max) {
      return Math.random() * (max - min) + min;
    }

    function generateSensorArrays(numSensor) {
      let sensorArrays = [];
      
      for (let sensor = 1; sensor <= numSensor; sensor++) {
        let array = [];
        for (let i = 0; 6 > i; i++) {
          switch (i) {
            case 0:
              array.push(getRandomNumber(400, 2500));
              break;
            case 1:
              array.push(getRandomNumber(10, 300));
              break;
            case 2:
              array.push(getRandomNumber(30, 70));
              break;
            case 3:
              array.push(getRandomNumber(0, 12));
              break;
            case 4:
              array.push(getRandomNumber(40, 100));
              break;
            case 5:
              array.push(getRandomNumber(10, 100));
              break;
          }   
        }
        sensorArrays.push(array);
      }
      return sensorArrays;
    }

    function SetColorArray(school, floor, airQuality){
      let colorAy=[];
      let currentFloorData;
      if(school===1){
        if(floor==='Ground'){
          currentFloorData=cArray1;
        }else if (floor==='First'){
          currentFloorData=cArray2;
        }else if(floor==='Second'){
          currentFloorData=cArray3;
        }
      }else if(school===2){
        if(floor==='Floor29'){
          currentFloorData=sArray1;
        }else if(floor==='Floor30'){
          currentFloorData=sArray2;
        }else if(floor==='Floor31'){
          currentFloorData=sArray3;
        }
      } else if(school===3){
        currentFloorData=quarraArray;
      }
      if (airQuality=='CO2'){
        currentParameterData = getColumn(currentFloorData, 0);
      } 
      else if (airQuality=='PM2.5'){
        currentParameterData = getColumn(currentFloorData, 1);
      }
      else if (airQuality=='Dew Point'){
        currentParameterData = getColumn(currentFloorData, 2);
      }
      else if(airQuality=='TVOC'){
        currentParameterData = getColumn(currentFloorData, 3);
      }
      else if (airQuality=='Temperature'){
        currentParameterData = getColumn(currentFloorData, 4);
      }
      else if (airQuality=='Relative Humidity'){
        currentParameterData = getColumn(currentFloorData, 5);
      }
      const sensorAmount = currentFloorData.length;
      const dim = checkDim(airQuality);
      roomColor=[];
      for(let i=0;i<sensorAmount;i++){
        workingData = evaluateNumber(currentParameterData[i], dim);
        roomColor.push(workingData);
      }
      return roomColor;
    }

    function SetValueArray(school, floor, airQuality){
      let currentFloorData;
      if(school===1){
        if(floor==='Ground'){
          currentFloorData=cArray1;
        }else if (floor==='First'){
          currentFloorData=cArray2;
        }else if(floor==='Second'){
          currentFloorData=cArray3;
        }
      }else if(school===2){
        if(floor==='Floor29'){
          currentFloorData=sArray1;
        }else if(floor==='Floor30'){
          currentFloorData=sArray2;
        }else if(floor==='Floor31'){
          currentFloorData=sArray3;
        }
      } else if(school===3){
        currentFloorData=quarraArray;
      }
      if (airQuality=='CO2'){
        currentParameterData = getColumn(currentFloorData, 0);
      } 
      else if (airQuality=='PM2.5'){
        currentParameterData = getColumn(currentFloorData, 1);
      }
      else if (airQuality=='Dew Point'){
        currentParameterData = getColumn(currentFloorData, 2);
      }
      else if(airQuality=='TVOC'){
        currentParameterData = getColumn(currentFloorData, 3);
      }
      else if (airQuality=='Temperature'){
        currentParameterData = getColumn(currentFloorData, 4);
      }
      else if (airQuality=='Relative Humidity'){
        currentParameterData = getColumn(currentFloorData, 5);
      }
      return currentParameterData;
    }

    const thresholds = {
      dim1: { red: [2000, -10], yellow: [1000, -5] },
      dim2: { red: [250, -10], yellow: [18, -5] },
      dim3: { red: [60, -10], yellow: [55, -5] },
      dim4: { red: [10, -10], yellow: [1, -5] },
      dim5: { red: [90, 55], yellow: [81, 65] },
      dim6: { red: [80, 20], yellow: [60, 30] }
    };

    function evaluateNumber(number, dim) {
      const threshold = thresholds['dim' + dim];
      const redMax = threshold.red[0];
      const redMin = threshold.red[1];
      const yellowMax = threshold.yellow[0];
      const yellowMin = threshold.yellow[1];

      if (number > redMax || number < redMin) {
          return 'red';
      } else if ((number < redMax && number > yellowMax) || (number < yellowMin && number > redMin)) {
          return 'yellow';
      } else {
          return 'green';
      }
    }

    function checkDim(input){
      if (input=='CO2'){
        return 1;
      }
      else if (input=='PM2.5'){
        return 2;
      }
      else if (input=='Dew Point'){
        return 3;
      }
      else if (input=='TVOC'){
        return 4;
      }
      else if (input=='Temperature'){
        return 5;
      }
      else {
        return 6;
      }
    }

    function getColumn(array, i) {
        var column = [];
        for (var j = 0; j < array.length; j++) {
            column.push(array[j][i]);
        }
        return column;
    }

    document.addEventListener('DOMContentLoaded', function () {
      function returnToInitialMapView() {
        map.setView(initialMapCenter, initialMapZoom);
      }

      document.getElementById('returnButton').addEventListener('click', returnToInitialMapView);

      document.querySelectorAll('.chart-parameter').forEach(button => {
        button.addEventListener('click', function () {
          setActiveParameter(this);
        });
      });

      document.querySelectorAll('.chart-date').forEach(button => {
        button.addEventListener('click', function () {
          setActiveDate(this);
        });
      });

      document.getElementById('button41').classList.add('active');
      document.getElementById('hour').classList.add('active');

      drawCurve();
    });

    const buttonIdToLabelMap = {
      'button41': 'CO2 (ppm)',
      'button42': 'PM2.5 (µg/m\u00B3)',
      'button43': 'Dew Point (\u00B0F)',
      'button44': 'TVOC (µg/m\u00B3)',
      'button45': 'TEMP (\u00B0F)',
      'button46': 'RH (%)'
    };

    function setActiveParameter(button) {
      document.querySelectorAll('.chart-parameter').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      activeChartParameter = button.id;
      drawCurve();
    }

    function setActiveDate(button) {
      document.querySelectorAll('.chart-date').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      activeChartDate = button.id;
      drawCurve();
    }

    function updateExplanation(option) {
      var explanationText;
      switch (option) {
        case 'option1':
          explanationText = `
            <div class="legend">
              <h4>Carbon Dioxide (ppm)</h4>
              <div><span style="background-color: #00ff00;"></span> < 1000 Typical</div>
              <div><span style="background-color: #ffff00;"></span> 1000 - 2000 Moderate</div>
              <div><span style="background-color: #ff0000;"></span> > 2000 High</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        case 'option2':
        explanationText = `
            <div class="legend">
              <h4>Particulate Matter 2.5 (ug/m<sup>3</sup>)</h4>
              <div><span style="background-color: #00ff00;"></span> < 19 Typical</div>
              <div><span style="background-color: #ffff00;"></span> 19 - 250 Moderate</div>
              <div><span style="background-color: #ff0000;"></span> > 250 High</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        case 'option3':
        explanationText = `
            <div class="legend">
              <h4>Dew Point (\u00B0F)</h4>
              <div><span style="background-color: #00ff00;"></span> < 55 Typical</div>
              <div><span style="background-color: #ffff00;"></span> 55-60 Elevated</div>
              <div><span style="background-color: #ff0000;"></span> > 60 High</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        case 'option4':
        explanationText = `
            <div class="legend">
              <h4>TVOC (ug/m<sup>3</sup>)</h4>
              <div><span style="background-color: #00ff00;"></span> < 1 Good</div>
              <div><span style="background-color: #ffff00;"></span> 1 - 10 Elevated</div>
              <div><span style="background-color: #ff0000;"></span> > 10 High</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        case 'option5':
        explanationText = `
            <div class="legend">
              <h4>Temperature (\u00B0F)</h4>
              <div><span style="background-color: #00ff00;"></span> 65-81 Typical</div>
              <div><span style="background-color: #ffff00;"></span> 55-65 Slightly Low</div>
              <div><span style="background-color: #ffff00;"></span> 81-90 Slightly High</div>
              <div><span style="background-color: #ff0000;"></span> > 90 High</div>
              <div><span style="background-color: #ff0000;"></span> < 55 Low</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        case 'option6':
        explanationText = `
            <div class="legend">
              <h4>Relative Humidity (%)</h4>
              <div><span style="background-color: #00ff00;"></span> 30-60 Typical</div>
              <div><span style="background-color: #ffff00;"></span> 20-30 Slightly Low</div>
              <div><span style="background-color: #ffff00;"></span> 60-80 Slightly High</div>
              <div><span style="background-color: #ff0000;"></span> > 80 High</div>
              <div><span style="background-color: #ff0000;"></span> < 20 Low</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        default:
          explanationText = 'Default explanation.';
      }
      var explanationDiv = document.getElementById('explanation');
      if (explanationDiv) {
        explanationDiv.innerHTML = explanationText;
      } else {
        console.error("Explanation div not found");
      }
    }

    document.getElementById('btn1').addEventListener('click', function() {
      updateExplanation('option1');
    });
    document.getElementById('btn2').addEventListener('click', function() {
      updateExplanation('option2');
    });
    document.getElementById('btn3').addEventListener('click', function() {
      updateExplanation('option3');
    });
    document.getElementById('btn4').addEventListener('click', function() {
      updateExplanation('option4');
    });
    document.getElementById('btn5').addEventListener('click', function() {
      updateExplanation('option5');
    });
    document.getElementById('btn6').addEventListener('click', function() {
      updateExplanation('option6');
    });

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('btn3').click();
    });

    function drawCurve() {
      const ctx = document.getElementById('curveCanvas').getContext('2d');
      let labels = [];
      if (activeChartDate === 'hour') {
        labels = ['00', '05', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55'];
      } else if (activeChartDate === 'day') {
        labels = ['0:00', '2:00', '4:00', '6:00', '8:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00'];
      } else if (activeChartDate === 'week') {
        labels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      } else if (activeChartDate === 'month') {
        labels = ['00', '05', '10', '15', '20', '25', '30'];
      } else if (activeChartDate === 'year') {
        labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      }

      let data = [];
      let yMin = 0;
      let yMax = 0;
      if (activeChartParameter === 'button41') {
        data = [1020, 2000, 1500, 1800, 1030, 2035, 840, 1145, 1150, 955, 960, 965];
        yMin = 600;
        yMax = 2200;
      } else if (activeChartParameter === 'button42') {
        data = [30, 15, 50, 260, 180, 130, 170, 200, 180, 70, 12, 8];
        yMin = 10;
        yMax = 260;
      } else if (activeChartParameter === 'button43') {
        data = [40, 45, 50, 55, 65, 80, 65, 50, 45, 50, 55, 60];
        yMin = 45;
        yMax = 70;
      } else if (activeChartParameter === 'button44') {
        data = [0.1, 0.5, 2, 4, 6, 8, 9, 11, 13, 10, 9, 8];
        yMin = 0;
        yMax = 12;
      } else if (activeChartParameter === 'button45') {
        data = [40, 55, 60, 70, 85, 90, 95, 80, 75, 50, 55, 60];
        yMin = 40;
        yMax = 95;
      } else if (activeChartParameter === 'button46') {
        data = [30, 35, 40, 50, 35, 60, 55, 65, 40, 50, 55, 60];
        yMin = 15;
        yMax = 85;
      }

      const chartLabel = buttonIdToLabelMap[activeChartParameter] || 'Curve Data';

      const smallScreen = window.innerHeight < 550;
      const fontSize = smallScreen ? 10 : 12;

      if (chart) {
        chart.destroy();
      }

      const horizontalLinePlugin = {
        id: 'horizontalLine',
        afterDraw: (chart) => {
          const yScale = chart.scales.y;
          const ctx = chart.ctx;
          if (activeChartParameter === 'button41') {
            const yValues = [1000, 2000];
            const colors = ['yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          } else if (activeChartParameter === 'button42') {
            const yValues = [19, 250];
            const colors = ['yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          } else if (activeChartParameter === 'button43') {
            const yValues = [55, 65];
            const colors = ['yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          } else if (activeChartParameter === 'button44') {
            const yValues = [1, 10];
            const colors = ['yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          } else if (activeChartParameter === 'button45') {
            const yValues = [55, 65, 81, 90];
            const colors = ['red', 'yellow', 'yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          } else if (activeChartParameter === 'button46') {
            const yValues = [20, 30, 60, 80];
            const colors = ['red', 'yellow', 'yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          }
        }
      };

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: chartLabel,
            data: data,
            borderColor: 'blue',
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              ticks: {
                font: {
                  size: fontSize
                }
              }
            },
            y: {
              ticks: {
                font: {
                  size: fontSize
                }
              },
              suggestedMin: yMin,
              suggestedMax: yMax
            }
          },
          plugins: {
            legend: {
              labels: {
                font: {
                  size: fontSize
                }
              }
            },
            zoom: {
              pan: {
                enabled: true,
                mode: 'xy',
                threshold: 5
              },
              zoom: {
                wheel: {
                  enabled: true
                },
                pinch: {
                  enabled: true
                },
                mode: 'xy'
              }
            }
          }
        },
        plugins: [horizontalLinePlugin]
      });
    }

    // Function to update data every 5 minutes
    async function updateData() {
      try {
        const rawData = await fetchData();
        if (rawData) {
          quarraArray = processDevices("Quarra Stone", rawData);
          quarraArray = sortArrayByOrder(quarraArray, qdesiredOrder);
          CJAArray = processDevices("CJA", rawData);
          CJAArray = sortArrayByOrder(CJAArray, cdesiredOrder);
          shoreArray = processDevices("Shore Capital Partners", rawData);
          shoreArray = sortArrayByOrder(shoreArray, sdesiredOrder);
          quarraStatus = quarraArray.map(device => device[7]);
          CJAStatus = CJAArray.map(device => device[7]);
          shoreStatus =shoreArray.map(device => device[7]);
          quarraOnlinePercent = calculateOnlinePercent(quarraStatus);
          CJAOnlinePercent = calculateOnlinePercent(CJAStatus);
          shoreOnlinePercent = calculateOnlinePercent(shoreStatus);
          // Update markers with new data
          updateMarkers(quarraOnlinePercent, CJAOnlinePercent, shoreOnlinePercent);
        }
      } catch (error) {
        console.error('Error fetching and processing data:', error);
      }
    }

    // Function to update markers
    function updateMarkers(quarraOnlinePercent, CJAOnlinePercent, shoreOnlinePercent) {
      var pieData1 = [
        { color: 'green', percentage: CJAOnlinePercent },
        { color: 'black', percentage: 100-CJAOnlinePercent }
      ];

      var pieData2 = [
        { color: 'green', percentage: shoreOnlinePercent},
        { color: 'black', percentage: 100 - shoreOnlinePercent}
      ];

      var pieData3 = [
        { color: 'green', percentage: quarraOnlinePercent },
        { color: 'black', percentage: 100-quarraOnlinePercent }
      ];

      markerArray[0].setIcon(createPiechartIcon(pieData1, 40, "20"));
      markerArray[1].setIcon(createPiechartIcon(pieData2, 40, "10"));
      markerArray[2].setIcon(createPiechartIcon(pieData3, 40, "8"));

      updateVisibleMarkers();
    }

    // Update data every 5 minutes
    setInterval(updateData, 5 * 60 * 1000);

  </script>
</body>
</html>
