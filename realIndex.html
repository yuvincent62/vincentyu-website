<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Project</title>
  <link rel="stylesheet" href="stylefile.css">
  <link rel="stylesheet" href="chart.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <script src="rooms.js"></script>
</head>

<body>
  <div id="map"></div>

  <div class="explanation" id="explanation" aria-live="polite">Explanation goes here</div>

  <div id="topCanvas"></div>
  <div id="returnCanvas">
    <div class="buttonContainer">
      <button id="returnButton" class="buttonTop">Reset</button>
    </div>
  </div>
  <div id="canvasContainer4">
    <div id="canvas4">
      <div class="top-buttons">
        <div class="button-container">
          <button class="chart-parameter" id="button41"></button>
          <span class="label">CO2</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button42"></button>
          <span class="label">PM2.5</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button43"></button>
          <span class="label">Dew Point</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button44"></button>
          <span class="label">TVOC</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button45"></button>
          <span class="label">TEMP</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button46"></button>
          <span class="label">RH</span>
        </div>
      </div>
      <canvas id="curveCanvas" width="800" height="400"></canvas>
      <div class="chart-buttons">
        <div class="button-container">
          <button class="chart-date" id="hour"></button>
          <span class="label">Hour</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="day"></button>
          <span class="label">Day</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="week"></button>
          <span class="label">Week</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="month"></button>
          <span class="label">Month</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="year"></button>
          <span class="label">Year</span>
        </div>
      </div>
    </div>
    <div id="buttonContainer">
      <div id="closeButton">Return to Map</div>
      <div id="getCSVButton">Get CSV</div>
    </div>
  </div>
  <div id="bottomCanvas">
    <div class="bottomButtonContainer">
      <button id="btn1" class="button buttonBottom"></button><span class="bottomButtonText">CO2</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn2" class="button buttonBottom"></button><span class="bottomButtonText">PM2.5</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn3" class="button buttonBottom"></button><span class="bottomButtonText">Dew Point</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn4" class="button buttonBottom"></button><span class="bottomButtonText">TVOC</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn5" class="button buttonBottom"></button><span class="bottomButtonText">Temperature</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn6" class="button buttonBottom"></button><span class="bottomButtonText">Relative Humidity</span>
    </div>
  </div>
  <div id="overlay"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZ9erro9k6fImEbGmGdGjLxf2kFdPC4lI"></script>

  <script> 

    // Define global variables to store the arrays
    let quarraArray = [];
    let CJAArray = [];
    let quarraStatus = [];
    let CJAStatus = [];
    let quarraOnlinePercent = 0;
    let CJAOnlinePercent = 0;
    let chart;
    let accessToken = '';
    let tokenSpan = 0;
    let cArray1 = [];
    let cArray2 = [];
    let cArray3 = [];
    
    async function requestAccessToken() {
      const clientId = client_Id;
      const clientSecret = client_Secret;
      const apiKey = process.env.api_Key;

      const credentials = `${clientId}:${clientSecret}`;
      const encodedCredentials = btoa(credentials);

      const myHeaders = new Headers();
      myHeaders.append("Authorization", `Basic ${encodedCredentials}`);

      const requestOptions = {
        method: "POST",
        headers: myHeaders,
        redirect: "follow"
      };

      const grantType = "client_credentials";
      const url = `https://nkh3da6ksg.execute-api.us-east-1.amazonaws.com/v1/accesstoken?grant_type=${grantType}`;

      try {
        const response = await fetch(url, requestOptions);
        const result = await response.json();
        accessToken = result.access_token;
        tokenSpan = (result.expires_in - 60) * 1000;
      } catch (error) {
        console.error(error);
      }
    }

    const myHeaders = new Headers();
    myHeaders.append("x-api-key", apiKey);

    async function fetchData() {
      try {      
        await requestAccessToken();
        myHeaders.append("Authorization", `Bearer ${accessToken}`);
        const requestOptions = {
          method: "GET",
          headers: myHeaders,
          redirect: "follow"
        };
//        console.log('inside try: ' + accessToken);
        const response = await fetch("https://nylc1ow0ih.execute-api.us-east-1.amazonaws.com/v1/partner/user/tdemonte@madisoniaq.com/home/details", requestOptions);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const rawData = await response.json();
//        console.log('Raw Data:', rawData);
        return rawData;
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    // Function to calculate dew point using the Magnus-Tetens formula
    function calculateDewPointCelsius(temperatureC, humidity) {
        const a = 17.27;
        const b = 237.7;
        const alpha = ((a * temperatureC) / (b + temperatureC)) + Math.log(humidity / 100);
        const dewPointC = (b * alpha) / (a - alpha);
        return dewPointC;
    }

    // Function to convert Celsius to Fahrenheit
    function celsiusToFahrenheit(celsius) {
        return celsius * 9 / 5 + 32;
    }

    // Function to process the devices for a specific home name
    function processDevices(homeName, rawData) {
        const homeData = rawData.find(item => item.homeName === homeName);
        if (homeData) {
            return homeData.rooms.flatMap(room => {
                return room.devices.map(device => {
                    const { deviceId, deviceName, deviceStatus, co2, pm25, tvoc, temperature, humidity } = device;
                    const dewPointC = calculateDewPointCelsius(temperature, humidity);
                    const dewPointF = parseFloat(celsiusToFahrenheit(dewPointC).toFixed(1));
                    const temperatureF = parseFloat(celsiusToFahrenheit(temperature).toFixed(1));
                    return [co2, pm25, dewPointF, tvoc, temperatureF, humidity, deviceName, deviceStatus];
                });
            });
        } else {
            console.log(`Home ${homeName} not found in raw data.`);
            return [];
        }
    }

    // Desired order for quarraArray
    const qdesiredOrder = [
        "Plant 2 - Sensor A",
        "Plant 2 - Sensor B",
        "Plant 2 - Sensor C",
        "Plant 2 - Sensor D",
        "Plant 2 - Sensor E",
        "Plant 2 - Sensor F",
        "Plant 2 - Sensor G",
        "Plant 2 - Sensor H",
        "1",
        "Plant 2"
    ];

            // Desired order for quarraArray
            const cdesiredOrder = [
        "G14",
        "Admin Hall G21/G22",
      	"Cafeteria East",
        "G33",
        "115",
      	"111",
        "135",
        "136",
        "137",
        "138",
        "141",
        "142",
        "Gym Sensor East",
        "210",
        "231",
        "232",
        "233",
        "234",
        "235",
        "236",
    ];

    // Function to sort array based on desired order
    function sortArrayByOrder(array, order) {
        const orderMap = new Map(order.map((name, index) => [name, index]));
        
        const sortedArray = array.slice().sort((a, b) => {
            const nameA = a[6];
            const nameB = b[6];
            const posA = orderMap.has(nameA) ? orderMap.get(nameA) : order.length;
            const posB = orderMap.has(nameB) ? orderMap.get(nameB) : order.length;
            return posA - posB;
        });

        return sortedArray;
    }

    // Function to calculate the percentage of "Online" statuses in an array
    function calculateOnlinePercent(statusArray) {
        if (statusArray.length === 0) {
            console.log('The array is empty.');
            return 0;
        }

        let onlineCount = 0;
        let offlineCount = 0;

        for (let status of statusArray) {
            if (status === "Online") {
                onlineCount++;
            } else {
                offlineCount++;
            }
        }

        const onlinePercent = (onlineCount / statusArray.length) * 100;
//        console.log(`Online Percent: ${onlinePercent.toFixed(2)}%`);
        return onlinePercent;
    }

    // Function to handle option changes
    function onOptionChange(prop, value) {
//      console.log(`The ${prop} was changed to ${value}`);
      if (prop === 'topOption') {
        defineAndDisplayRoomMarkers(schoolSelection, value, activeBottomButtonText);
      } else if (prop === 'bottomOption') {
        defineAndDisplayRoomMarkers(schoolSelection, options.topOption, activeBottomButtonText);
      }
    }

    // Function to update marker colors
    function updateMarkerColors(colorArray) {
      var visibleMarkers = roomMarkers.filter(function (room) {
        return room.marker.options.opacity === 1;
      });

      visibleMarkers.forEach(function (room, index) {
        if (index < colorArray.length) {
          room.updateColor(colorArray[index]);
        }
      });
    }

    // Call the fetchData function and process the data initially
    fetchData().then(rawData => {
        if (rawData) {
            quarraArray = processDevices("Quarra Stone", rawData);
            quarraArray = sortArrayByOrder(quarraArray, qdesiredOrder);
//            console.log('Sorted Quarra Array:', quarraArray);

            CJAArray = processDevices("CJA", rawData);
            CJAArray = sortArrayByOrder(CJAArray, cdesiredOrder);
//            console.log('Sorted CJA Array:', CJAArray);
            cArray1 = CJAArray.slice(0,4);
            cArray2 = CJAArray.slice(4,13);
            cArray3 = CJAArray.slice(13,20);

            quarraStatus = quarraArray.map(device => device[7]);
//            console.log('Quarra Status:', quarraStatus);

            CJAStatus = CJAArray.map(device => device[7]);
//            console.log('CJA Status:', CJAStatus);

            quarraOnlinePercent = calculateOnlinePercent(quarraStatus);
            CJAOnlinePercent = calculateOnlinePercent(CJAStatus);

//            console.log(`Quarra Online Percent: ${quarraOnlinePercent.toFixed(2)}%`);
//            console.log(`CJA Online Percent: ${CJAOnlinePercent.toFixed(2)}%`);

            initMap(quarraOnlinePercent, CJAOnlinePercent);
        }
    });

    function initMap(quarraOnlinePercent, CJAOnlinePercent) {
//      console.log('Initializing map with quarraOnlinePercent:', quarraOnlinePercent);
//      console.log('Initializing map with CJAOnlinePercent:', CJAOnlinePercent);

      var options = {
          center: initialMapCenter,
          zoom: initialMapZoom,
          maxZoom: 19.5,
          zoomDelta: 2,
          wheelPxPerZoomLevel: 50,
          scrollWheelZoom: false,
          dragging: false,
          touchZoom: false,
          doubleClickZoom: false
      };

      map = L.map('map', options);

      var roadMapLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 19.5,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: 'Map data &copy; Google'
      }).addTo(map);

      var satelliteMapLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 19.5,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: 'Map data &copy; Google'
      });

      var baseMaps = {
        "Road Map": roadMapLayer,
        "Satellite View": satelliteMapLayer
      };

      var layerControl = L.control.layers(baseMaps, null, {
        position: 'topleft'
      }).addTo(map);

      var pieData1 = [
        { color: 'green', percentage: CJAOnlinePercent },
        { color: 'black', percentage: 100-CJAOnlinePercent }
      ];

      var pieData2 = [
        { color: 'green', percentage: 40 },
        { color: 'black', percentage: 50 }
      ];

      var pieData3 = [
        { color: 'green', percentage: quarraOnlinePercent },
        { color: 'black', percentage: 100-quarraOnlinePercent }
      ];

//      console.log('pieData3:', pieData3);

      const marker1 = L.marker([41.877331, -87.751678], { icon: createPiechartIcon(pieData1, 40, "28"), name: "Chicago Jesuit Academy", zIndexOffset: 1000 }).addTo(map);
      marker1.bindPopup("<b>Chicago Jesuit Academy</b>");
      markerArray.push(marker1);

      marker1.on('click', function (e) {
        var lng = e.latlng.lng;
        var lat = e.latlng.lat;
        onMarkerClick(lat, lng);
      });

      const marker3 = L.marker([43.2084038, -89.1974613], { icon: createPiechartIcon(pieData3, 40, "10"), name: "Quarra Stone", zIndexOffset: 1000 }).addTo(map);
      marker3.bindPopup("<b>Quarra Stone</b>");
      markerArray.push(marker3);

      marker3.on('click', function (e) {
        var lng = e.latlng.lng;
        var lat = e.latlng.lat;
        onMarkerClick(lat, lng);
      });

      markerArray.forEach(function (marker) {
        marker.on('mouseover', function () {
          if (this.options.opacity === 1) {
            this.openPopup();
          }
        });

        marker.on('mouseout', function () {
          this.closePopup();
        });
      });

      map.on('moveend', function () {
        updateVisibleMarkers();
      });

      map.on('zoomend', function () {
        updateVisibleMarkers();
        if (map.getZoom() >= 19.5) {
          layerControl._container.style.pointerEvents = 'none';
          layerControl._container.style.opacity = '0.5';
        } else {
          layerControl._container.style.pointerEvents = 'auto';
          layerControl._container.style.opacity = '1';
        }
      });

      map.on('load', function () {
        map.scrollWheelZoom.enable();
        map.dragging.enable();
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
      });

      map.whenReady(function () {
        map.scrollWheelZoom.enable();
        map.dragging.enable();
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
      });

      updateVisibleMarkers();

      activateButton(document.getElementById('btn3').parentElement.querySelector('.button'), 'bottomCanvas');

      document.getElementById('returnButton').addEventListener('click', returnToInitialMapView);

      updateExplanation('option1');
    }

    function hideCanvas(canvasId) {
      var canvas = document.getElementById(canvasId);
      if (canvas) {
        canvas.style.display = 'none';
      }
    }

    function showCanvas(canvasId) {
      var canvas = document.getElementById(canvasId);
      if (canvas) {
        canvas.style.display = 'flex';
        if (canvasId === 'bottomCanvas') {
          canvas.style.flexDirection = 'column';
        }
      }
    }

    document.getElementById('topCanvas').addEventListener('click', function (event) {
      if (event.target && event.target.matches('.buttonTop')) {
        clearRoomMarkers();
        activateButton(event.target, 'topCanvas');
      }
    });

    document.getElementById('bottomCanvas').addEventListener('click', function (event) {
      if (event.target && event.target.matches('.buttonBottom')) {
        activateButton(event.target, 'bottomCanvas');
      }
    });

    function onMarkerClick(lat, lng) {
//      console.log("Marker clicked at latitude:", lat, "and longitude:", lng);
      map.setView([lat, lng], map.getMaxZoom() - 2);
      drawCurve();  // Ensure drawCurve is called here
    }

    function hideCanvas4() {
      document.getElementById('canvasContainer4').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    document.getElementById('closeButton').onclick = hideCanvas4;

    document.getElementById('getCSVButton').addEventListener('click', generateAndDownloadCSV);

    function generateAndDownloadCSV() {
      const data = cArray3;
      const csvContent = data.map(e => e.join(",")).join("\n");

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

      const link = document.createElement("a");
      if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", "data.csv");
          
          document.body.appendChild(link);
          link.click();
          
          document.body.removeChild(link);
      }
    }

    let zoomLevel = false;
    let schoolSelection = null;
    let map;
    let markerArray = [];
    let roomMarkers = [];
    let activeTopButtonId = 'top1';
    let activeBottomButtonText = 'Dew Point';
    const initialMapCenter = [43.0731, -89.4012];
    const initialMapZoom = 8;
    let activeChartParameter = 'CO2';
    let activeChartDate = 'hour';
    let activeRoomName = '';
    let options = {
      topOption: 'Ground',
      bottomOption: 'Dew Point'
    };

    function updateVisibleMarkers() {
      var visibleMarkers = markerArray.filter(function (marker) {
        return map.getBounds().contains(marker.getLatLng());
      });

//      console.log('Visible Markers:', visibleMarkers.map(marker => marker.options.name));

      var zoomLevel = map.getZoom() >= 18;
      const arrayLength = markerArray.length;

      if (zoomLevel) {
        var schoolPass = null;
        if (visibleMarkers.length === 1) {
          schoolPass = visibleMarkers[0].options.name;
        }

        if (schoolPass === 'Chicago Jesuit Academy') {
          schoolSelection = 1;
        } else if (schoolPass === 'School 2') {
          schoolSelection = 2;
        } else if (schoolPass === 'Quarra Stone') {
          schoolSelection = 3;
        }
        else {
          schoolSelection = null;
        }

        if (schoolSelection !== null) {
          createTopCanvasButtons(schoolSelection);
        }

        for (let i = 0; i < arrayLength; i++) {
          markerArray[i].setOpacity(0);
          markerArray[i].closePopup();
          markerArray[i].unbindPopup();
        }
        showCanvas('topCanvas');
        showCanvas('bottomCanvas');
        showCanvas('explanation');
        defineAndDisplayRoomMarkers(schoolSelection, options.topOption);

        var firstTopButton = document.querySelector('#topCanvas .buttonTop');
        if (firstTopButton) {
          firstTopButton.click();
        }

        var thirdBottomButton = document.querySelectorAll('#bottomCanvas .buttonBottom')[2];
        if (thirdBottomButton) {
          thirdBottomButton.click();
        }
      } else {
        for (let i = 0; i < arrayLength; i++) {
          markerArray[i].setOpacity(1);
          markerArray[i].bindPopup(`<b>${markerArray[i].options.name}</b>`);
        }
        hideCanvas('topCanvas');
        hideCanvas('bottomCanvas');
        hideCanvas('explanation');
        clearRoomMarkers();
      }
    }

    function clearRoomMarkers() {
      roomMarkers.forEach(function (roomMarker) {
        map.removeLayer(roomMarker.marker);
      });
      roomMarkers = [];
    }

    function activateButton(button, canvasId) {
      var canvasType = canvasId === 'topCanvas' ? 'topOption' : 'bottomOption';

      var buttons = document.querySelectorAll('#' + canvasId + ' .buttonTop, #' + canvasId + ' .buttonBottom');
      buttons.forEach(function (btn) {
        btn.classList.remove('active');
        btn.style.backgroundColor = "white";
        btn.style.color = "black";
      });

      button.classList.add('active');
      button.style.backgroundColor = "green";
      button.style.color = "white";

      options[canvasType] = button.nextElementSibling.textContent.trim();

      if (canvasId === 'topCanvas') {
        activeTopButtonId = button.id;
      } else if (canvasId === 'bottomCanvas') {
        activeBottomButtonText = button.nextElementSibling.textContent.trim();
      }

      onOptionChange(canvasType, options[canvasType]);

      const currentSchool = schoolSelection;
      const currentFloor = options.topOption;
      const currentParameter = activeBottomButtonText;
      let colorArray = [];
      zoomLevel = (map.getZoom()>=18);    
      if (zoomLevel) {
        colorArray = SetColorArray(currentSchool, currentFloor, currentParameter);
      }
      updateMarkerColors(colorArray);
    }

    function createTopCanvasButtons(school) {
      var topCanvas = document.getElementById('topCanvas');
      topCanvas.innerHTML = '';
    
      var buttonNames;
      if (school === 1) {
        buttonNames = ['Ground', 'First', 'Second'];
      } else if(school === 2){
        buttonNames = ['Floor1', 'Floor2'];
      } else if(school === 3){
          buttonNames = ['null'];
      }
      if ( buttonNames!='null'){
        buttonNames.forEach(function (name, index) {
          var buttonContainer = document.createElement('div');
          buttonContainer.className = 'buttonContainer';
          var button = document.createElement('button');
          button.id = 'top' + (index + 1);
          button.className = 'buttonTop';
          button.onclick = function () { activateButton(this, 'topCanvas'); };
          var span = document.createElement('span');
          span.className = 'buttonText';
          span.textContent = name;
          buttonContainer.appendChild(button);
          buttonContainer.appendChild(span);
          topCanvas.appendChild(buttonContainer);
        });
        var firstButton = topCanvas.querySelector('.buttonTop');
        if (firstButton) {
          activateButton(firstButton, 'topCanvas');
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      var initialMapCenter = [43.0731, -89.4012];
      var initialMapZoom = 8;
  
      function returnToInitialMapView() {
//        console.log("Return button clicked");
        map.setView(initialMapCenter, initialMapZoom);
      }
  
      document.getElementById('returnButton').addEventListener('click', returnToInitialMapView);
    });
  
    function createPiechartIcon(data, size, text) {
  function percentageToAngle(percentage) {
    return (percentage / 100) * 360;
  }

  function describeArc(x, y, radius, startAngle, endAngle) {
    var start = polarToCartesian(x, y, radius, endAngle);
    var end = polarToCartesian(x, y, radius, startAngle);
    var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

    var d = [
      "M", x, y,
      "L", start.x, start.y,
      "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
      "Z"
    ].join(" ");
    return d;
  }

  function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
    var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
    return {
      x: centerX + (radius * Math.cos(angleInRadians)),
      y: centerY + (radius * Math.sin(angleInRadians))
    };
  }

  var startAngle = 0;
  var paths = data.map(function(segment) {
    var percentage = segment.percentage;
    if (percentage === 100) {
      percentage = 99.999; // Slightly reduce the percentage to avoid full circle rendering issue
    }
    var endAngle = startAngle + percentageToAngle(percentage);
    var path = describeArc(16, 16, 16, startAngle, endAngle);
    startAngle = endAngle;
    return `<path d="${path}" fill="${segment.color}"/>`;
  }).join("");

  var svg = `
    <svg width="${size}" height="${size}" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
      ${paths}
      <circle cx="16" cy="16" r="10" fill="white"/>
      <text x="16" y="21" font-size="10" text-anchor="middle" fill="#000">${text}</text>
    </svg>`;
  var url = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svg)));
  return new L.Icon({
    iconUrl: url,
    iconSize: [size, size],
    iconAnchor: [size / 2, size / 2],
    popupAnchor: [0, -size / 2]
  });
}

    function SetColorArray(school, floor, airQuality){
      let colorAy=[];
      let currentFloorData;
      if(school===1){
        if(floor==='Ground'){
          currentFloorData=cArray1;
        }else if (floor==='First'){
          currentFloorData=cArray2;
        }else if(floor==='Second'){
          currentFloorData=cArray3;
        }
      }else if(school===2){
        if(floor==='Floor1'){
          currentFloorData=array21;
        }else if(floor==='Floor2'){
          currentFloorData=array22;
        }
      } else if(school===3){
        currentFloorData=quarraArray;
      }
      if (airQuality=='CO2'){
        currentParameterData = getColumn(currentFloorData, 0);
      } 
      else if (airQuality=='PM2.5'){
        currentParameterData = getColumn(currentFloorData, 1);
      }
      else if (airQuality=='Dew Point'){
        currentParameterData = getColumn(currentFloorData, 2);
      }
      else if(airQuality=='TVOC'){
        currentParameterData = getColumn(currentFloorData, 3);
      }
      else if (airQuality=='Temperature'){
        currentParameterData = getColumn(currentFloorData, 4);
      }
      else if (airQuality=='Relative Humidity'){
        currentParameterData = getColumn(currentFloorData, 5);
      }
      const sensorAmount = currentFloorData.length;
      const dim = checkDim(airQuality);

      roomColor=[];
      for(let i=0;i<sensorAmount;i++){
        workingData = evaluateNumber(currentParameterData[i], dim);
        roomColor.push(workingData);
      }
      return roomColor;
    }

    function SetValueArray(school, floor, airQuality){
      let currentFloorData;
      if(school===1){
        if(floor==='Ground'){
          currentFloorData=cArray1;
        }else if (floor==='First'){
          currentFloorData=cArray2;
        }else if(floor==='Second'){
          currentFloorData=cArray3;
        }
      }else if(school===2){
        if(floor==='Floor1'){
          currentFloorData=array21;
        }else if(floor==='Floor2'){
          currentFloorData=array22;
        }
      } else if(school===3){
        currentFloorData=quarraArray;
      }
      if (airQuality=='CO2'){
        currentParameterData = getColumn(currentFloorData, 0);
      } 
      else if (airQuality=='PM2.5'){
        currentParameterData = getColumn(currentFloorData, 1);
      }
      else if (airQuality=='Dew Point'){
        currentParameterData = getColumn(currentFloorData, 2);
      }
      else if(airQuality=='TVOC'){
        currentParameterData = getColumn(currentFloorData, 3);
      }
      else if (airQuality=='Temperature'){
        currentParameterData = getColumn(currentFloorData, 4);
      }
      else if (airQuality=='Relative Humidity'){
        currentParameterData = getColumn(currentFloorData, 5);
      }
      return currentParameterData;
    }

//    console.log('*****************' + SetValueArray(1, 'Ground', 'CO2'));

    const thresholds = {
      dim1: { red: [2000, -10], yellow: [1000, -5] },
      dim2: { red: [250, -10], yellow: [18, -5] },
      dim3: { red: [60, -10], yellow: [55, -5] },
      dim4: { red: [10, -10], yellow: [1, -5] },
      dim5: { red: [90, 55], yellow: [81, 65] },
      dim6: { red: [80, 20], yellow: [60, 30] }
    };

    function evaluateNumber(number, dim) {
      const threshold = thresholds['dim' + dim];
      const redMax = threshold.red[0];
      const redMin = threshold.red[1];
      const yellowMax = threshold.yellow[0];
      const yellowMin = threshold.yellow[1];

      if (number > redMax || number < redMin) {
          return 'red';
      } else if ((number < redMax && number > yellowMax) || (number < yellowMin && number > redMin)) {
          return 'yellow';
      } else {
          return 'green';
      }
    }

    function checkDim(input){
      if (input=='CO2'){
        return 1;
      }
      else if (input=='PM2.5'){
        return 2;
      }
      else if (input=='Dew Point'){
        return 3;
      }
      else if (input=='TVOC'){
        return 4;
      }
      else if (input=='Temperature'){
        return 5;
      }
      else {
        return 6;
      }
    }

    function getColumn(array, i) {
        var column = [];
        for (var j = 0; j < array.length; j++) {
            column.push(array[j][i]);
        }
        return column;
    }

    document.addEventListener('DOMContentLoaded', function () {
      function returnToInitialMapView() {
//        console.log("Return button clicked");
        map.setView(initialMapCenter, initialMapZoom);
      }

      document.getElementById('returnButton').addEventListener('click', returnToInitialMapView);

      document.querySelectorAll('.chart-parameter').forEach(button => {
        button.addEventListener('click', function () {
          setActiveParameter(this);
        });
      });

      document.querySelectorAll('.chart-date').forEach(button => {
        button.addEventListener('click', function () {
          setActiveDate(this);
        });
      });

      document.getElementById('button41').classList.add('active');
      document.getElementById('hour').classList.add('active');

      drawCurve();
    });

    const buttonIdToLabelMap = {
      'button41': 'CO2 (ppm)',
      'button42': 'PM2.5 (µg/m\u00B3)',
      'button43': 'Dew Point (\u00B0F)',
      'button44': 'TVOC (µg/m\u00B3)',
      'button45': 'TEMP (\u00B0F)',
      'button46': 'RH (%)'
    };

    function setActiveParameter(button) {
      document.querySelectorAll('.chart-parameter').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      activeChartParameter = button.id;
//      console.log('Active parameter set to:', activeChartParameter);
      drawCurve();
    }

    function setActiveDate(button) {
      document.querySelectorAll('.chart-date').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      activeChartDate = button.id;
//      console.log('Active date set to:', activeChartDate);
      drawCurve();
    }

    function updateExplanation(option) {
      var explanationText;
      switch (option) {
        case 'option1':
          explanationText = `
            <div class="legend">
              <h4>Carbon Dioxide (ppm)</h4>
              <div><span style="background-color: #00ff00;"></span> < 1000 Typical</div>
              <div><span style="background-color: #ffff00;"></span> 1000 - 2000 Moderate</div>
              <div><span style="background-color: #ff0000;"></span> > 2000 High</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        case 'option2':
        explanationText = `
            <div class="legend">
              <h4>Particulate Matter 2.5 (ug/m<sup>3</sup>)</h4>
              <div><span style="background-color: #00ff00;"></span> < 19 Typical</div>
              <div><span style="background-color: #ffff00;"></span> 19 - 250 Moderate</div>
              <div><span style="background-color: #ff0000;"></span> > 250 High</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        case 'option3':
        explanationText = `
            <div class="legend">
              <h4>Dew Point (\u00B0F)</h4>
              <div><span style="background-color: #00ff00;"></span> < 55 Typical</div>
              <div><span style="background-color: #ffff00;"></span> 55-60 Elevated</div>
              <div><span style="background-color: #ff0000;"></span> > 60 High</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        case 'option4':
        explanationText = `
            <div class="legend">
              <h4>TVOC (ug/m<sup>3</sup>)</h4>
              <div><span style="background-color: #00ff00;"></span> < 1 Good</div>
              <div><span style="background-color: #ffff00;"></span> 1 - 10 Elevated</div>
              <div><span style="background-color: #ff0000;"></span> > 10 High</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        case 'option5':
        explanationText = `
            <div class="legend">
              <h4>Temperature (\u00B0F>)</h4>
              <div><span style="background-color: #00ff00;"></span> < 65-81 Typical</div>
              <div><span style="background-color: #ffff00;"></span> 55-65 Slightly Low</div>
              <div><span style="background-color: #ffff00;"></span> 81-90 Slightly High</div>
              <div><span style="background-color: #ff0000;"></span> > 90 High</div>
              <div><span style="background-color: #ff0000;"></span> < 55 Low</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        case 'option6':
        explanationText = `
            <div class="legend">
              <h4>Relative Humidity (%)</h4>
              <div><span style="background-color: #00ff00;"></span> < 30-60 Typical</div>
              <div><span style="background-color: #ffff00;"></span> 20-30 Slightly Low</div>
              <div><span style="background-color: #ffff00;"></span> 60-80 Slightly High</div>
              <div><span style="background-color: #ff0000;"></span> > 80 High</div>
              <div><span style="background-color: #ff0000;"></span> < 20 Low</div>
              <div><span style="background-color: #000000;"></span> Connection Lost</div>
              <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
            </div>`;
          break;
        default:
          explanationText = 'Default explanation.';
      }
      var explanationDiv = document.getElementById('explanation');
      if (explanationDiv) {
        explanationDiv.innerHTML = explanationText;
//        console.log("Explanation updated: ", explanationText);
      } else {
        console.error("Explanation div not found");
      }
    }

    document.getElementById('btn1').addEventListener('click', function() {
      updateExplanation('option1');
    });
    document.getElementById('btn2').addEventListener('click', function() {
      updateExplanation('option2');
    });
    document.getElementById('btn3').addEventListener('click', function() {
      updateExplanation('option3');
    });
    document.getElementById('btn4').addEventListener('click', function() {
      updateExplanation('option4');
    });
    document.getElementById('btn5').addEventListener('click', function() {
      updateExplanation('option5');
    });
    document.getElementById('btn6').addEventListener('click', function() {
      updateExplanation('option6');
    });

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('btn3').click();
    });

    function drawCurve() {
      const ctx = document.getElementById('curveCanvas').getContext('2d');
      let labels = [];
      if (activeChartDate === 'hour') {
        labels = ['00', '05', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55'];
      } else if (activeChartDate === 'day') {
        labels = ['0:00', '2:00', '4:00', '6:00', '8:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00'];
      } else if (activeChartDate === 'week') {
        labels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      } else if (activeChartDate === 'month') {
        labels = ['00', '05', '10', '15', '20', '25', '30'];
      } else if (activeChartDate === 'year') {
        labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      }

      let data = [];
      let yMin = 0;
      let yMax = 0;
      if (activeChartParameter === 'button41') {
        data = [1020, 2000, 1500, 1800, 1030, 2035, 840, 1145, 1150, 955, 960, 965];
        yMin = 600;
        yMax = 2200;
      } else if (activeChartParameter === 'button42') {
        data = [30, 15, 50, 260, 180, 130, 170, 200, 180, 70, 12, 8];
        yMin = 10;
        yMax = 260;
      } else if (activeChartParameter === 'button43') {
        data = [40, 45, 50, 55, 65, 80, 65, 50, 45, 50, 55, 60];
        yMin = 45;
        yMax = 70;
      } else if (activeChartParameter === 'button44') {
        data = [0.1, 0.5, 2, 4, 6, 8, 9, 11, 13, 10, 9, 8];
        yMin = 0;
        yMax = 12;
      } else if (activeChartParameter === 'button45') {
        data = [40, 55, 60, 70, 85, 90, 95, 80, 75, 50, 55, 60];
        yMin = 40;
        yMax = 95;
      } else if (activeChartParameter === 'button46') {
        data = [30, 35, 40, 50, 35, 60, 55, 65, 40, 50, 55, 60];
        yMin = 15;
        yMax = 85;
      }

      const chartLabel = buttonIdToLabelMap[activeChartParameter] || 'Curve Data';

//      console.log('####' + activeChartParameter);
//      console.log('####' + activeChartDate);

      const smallScreen = window.innerHeight < 550;
      const fontSize = smallScreen ? 10 : 12;

      if (chart) {
        chart.destroy();
      }

      const horizontalLinePlugin = {
        id: 'horizontalLine',
        afterDraw: (chart) => {
          const yScale = chart.scales.y;
          const ctx = chart.ctx;
          if (activeChartParameter === 'button41') {
            const yValues = [1000, 2000];
            const colors = ['yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          } else if (activeChartParameter === 'button42') {
            const yValues = [19, 250];
            const colors = ['yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          } else if (activeChartParameter === 'button43') {
            const yValues = [55, 65];
            const colors = ['yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          } else if (activeChartParameter === 'button44') {
            const yValues = [1, 10];
            const colors = ['yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          } else if (activeChartParameter === 'button45') {
            const yValues = [55, 65, 81, 90];
            const colors = ['red', 'yellow', 'yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          } else if (activeChartParameter === 'button46') {
            const yValues = [20, 30, 60, 80];
            const colors = ['red', 'yellow', 'yellow', 'red'];
            yValues.forEach((yValue, index) => {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(chart.chartArea.left, yScale.getPixelForValue(yValue));
              ctx.lineTo(chart.chartArea.right, yScale.getPixelForValue(yValue));
              ctx.strokeStyle = colors[index];
              ctx.lineWidth = 2;
              ctx.stroke();
              ctx.restore();
            });
          }
        }
      };

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: chartLabel,
            data: data,
            borderColor: 'blue',
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              ticks: {
                font: {
                  size: fontSize
                }
              }
            },
            y: {
              ticks: {
                font: {
                  size: fontSize
                }
              },
              suggestedMin: yMin,
              suggestedMax: yMax
            }
          },
          plugins: {
            legend: {
              labels: {
                font: {
                  size: fontSize
                }
              }
            },
            zoom: {
              pan: {
                enabled: true,
                mode: 'xy',
                threshold: 5
              },
              zoom: {
                wheel: {
                  enabled: true
                },
                pinch: {
                  enabled: true
                },
                mode: 'xy'
              }
            }
          }
        },
        plugins: [horizontalLinePlugin]
      });
    }

    // Function to update data every 5 minutes
    async function updateData() {
      try {
        const rawData = await fetchData();
        if (rawData) {
          quarraArray = processDevices("Quarra Stone", rawData);
          quarraArray = sortArrayByOrder(quarraArray, qdesiredOrder);
//          console.log('Updated Sorted Quarra Array:', quarraArray);

          CJAArray = processDevices("CJA", rawData);
          CJAArray = sortArrayByOrder(CJAArray, cdesiredOrder);
//          console.log('Sorted CJA Array:', CJAArray);
          cArray1 = CJAArray.slice(0,4);
          cArray2 = CJAArray.slice(4,13);
          cArray3 = CJAArray.slice(13,20);

          quarraStatus = quarraArray.map(device => device[7]);
//          console.log('Updated Quarra Status:', quarraStatus);

          CJAStatus = CJAArray.map(device => device[7]);
//          console.log('Updated CJA Status:', CJAStatus);

          quarraOnlinePercent = calculateOnlinePercent(quarraStatus);
          CJAOnlinePercent = calculateOnlinePercent(CJAStatus);

//          console.log(`Updated Quarra Online Percent: ${quarraOnlinePercent.toFixed(2)}%`);
//          console.log(`Updated CJA Online Percent: ${CJAOnlinePercent.toFixed(2)}%`);
          console.log('data has been updated');

          // Update markers with new data
          updateMarkers(quarraOnlinePercent, CJAOnlinePercent);
        }
      } catch (error) {
        console.error('Error fetching and processing data:', error);
      }
    }

    // Function to update markers
    function updateMarkers(quarraOnlinePercent, CJAOnlinePercent) {
      var pieData1 = [
        { color: 'green', percentage: CJAOnlinePercent },
        { color: 'black', percentage: 100-CJAOnlinePercent }
      ];

      var pieData2 = [
        { color: 'green', percentage: 40 },
        { color: 'black', percentage: 50 }
      ];

      var pieData3 = [
        { color: 'green', percentage: quarraOnlinePercent },
        { color: 'black', percentage: 100-quarraOnlinePercent }
      ];

//      console.log('Updated pieData3:', pieData3);

      markerArray[0].setIcon(createPiechartIcon(pieData1, 40, "28"));
      markerArray[1].setIcon(createPiechartIcon(pieData3, 40, "10"));

      updateVisibleMarkers();
    }

    // Update data every 5 minutes
    setInterval(updateData, 5 * 60 * 1000);

    //Update accessToken
    if (tokenSpan > 0) {
    setInterval(fetchAccessToken, tokenSpan);
}
  </script>
</body>
</html>

