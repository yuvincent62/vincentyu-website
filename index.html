<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Full Screen Map with Google Maps Tiles</title>
  <link rel="stylesheet" href="stylefile.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <style>
    .button, .buttonTop, .buttonBottom {
      border: 2px solid black;
      background-color: white;
      color: black;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .button.active, .buttonTop.active, .buttonBottom.active {
      background-color: green;
      color: white;
    }

    .buttonContainer {
      display: flex;
      align-items: center;
      margin: 5px;
    }

    .bottomButtonContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .buttonText {
      margin-left: 10px;
      white-space: nowrap;
    }

    .bottomButtonText {
      margin-left: 0;
      margin-top: 5px;
      white-space: nowrap;
    }

    #topCanvas, #bottomCanvas {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px;
    }

    #bottomCanvas {
      flex-direction: column;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="topCanvas"></div>
  <div id="bottomCanvas">
    <div class="bottomButtonContainer">
      <button id="btn1" class="button buttonBottom"></button><span class="bottomButtonText">CO2</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn2" class="button buttonBottom"></button><span class="bottomButtonText">PM2.5</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn3" class="button buttonBottom"></button><span class="bottomButtonText">Dew Point</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn4" class="button buttonBottom"></button><span class="bottomButtonText">TVOC</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn5" class="button buttonBottom"></button><span class="bottomButtonText">Temperature</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn6" class="button buttonBottom"></button><span class="bottomButtonText">Relative Humidity</span>
    </div>
  </div>

  <script>
    var zoomLevel = false;
    var schoolSelection = null;
    var map;
    var markerArray = [];
    var roomMarkers = [];
    var activeTopButtonId = 'top1';
    var activeBottomButtonText = 'Dew Point';

    var options = {
      topOption: 'Ground',
      bottomOption: 'Dew Point'
    };

    function activateButton(button, canvasId) {
      var canvasType = canvasId === 'topCanvas' ? 'topOption' : 'bottomOption';

      var buttons = document.querySelectorAll('#' + canvasId + ' .button, #' + canvasId + ' .buttonTop, #' + canvasId + ' .buttonBottom');
      buttons.forEach(function(btn) {
        btn.classList.remove('active');
        btn.style.backgroundColor = "white";
        btn.style.color = "black";
      });

      button.classList.add('active');
      button.style.backgroundColor = "green";
      button.style.color = "white";

      options[canvasType] = button.nextElementSibling.textContent.trim();

      if (canvasId === 'topCanvas') {
        activeTopButtonId = button.id;
      } else if (canvasId === 'bottomCanvas') {
        activeBottomButtonText = button.nextElementSibling.textContent.trim();
      }

      onOptionChange(canvasType, options[canvasType]);

      const currentSchool = schoolSelection;
      const currentFloor = options.topOption;
      const currentParameter = activeBottomButtonText;
      let colorArray = [];
      console.log('floor: ' + currentFloor);
      console.log('Parameter: ' + currentParameter);
      console.log('school' + currentSchool);

      zoomLevel = (map.getZoom() === 20.5);

      if (zoomLevel) {
        colorArray = SetColorArray(currentSchool, currentFloor, currentParameter);
        console.log('9999999999' + colorArray);
      }

      updateMarkerColors(colorArray);
    }

    function createTopCanvasButtons(school) {
      var topCanvas = document.getElementById('topCanvas');
      topCanvas.innerHTML = '';

      var buttonNames = school === 1 ? ['Ground', 'First', 'Second'] : ['Floor1', 'Floor2'];
      buttonNames.forEach(function(name, index) {
        var buttonContainer = document.createElement('div');
        buttonContainer.className = 'buttonContainer';
        var button = document.createElement('button');
        button.id = 'top' + (index + 1);
        button.className = 'buttonTop';
        button.onclick = function() { activateButton(this, 'topCanvas'); };
        var span = document.createElement('span');
        span.className = 'buttonText';
        span.textContent = name;
        buttonContainer.appendChild(button);
        buttonContainer.appendChild(span);
        topCanvas.appendChild(buttonContainer);
      });

      var activeButton = document.getElementById(activeTopButtonId);
      if (activeButton) {
        activateButton(activeButton, 'topCanvas');
      }
    }

    function createPiechartIcon(data, size, text) {
      function percentageToAngle(percentage) {
        return (percentage / 100) * 360;
      }

      function describeArc(x, y, radius, startAngle, endAngle) {
        var start = polarToCartesian(x, y, radius, endAngle);
        var end = polarToCartesian(x, y, radius, startAngle);
        var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

        var d = [
          "M", x, y,
          "L", start.x, start.y,
          "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
          "Z"
        ].join(" ");
        return d;
      }

      function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
        return {
          x: centerX + (radius * Math.cos(angleInRadians)),
          y: centerY + (radius * Math.sin(angleInRadians))
        };
      }

      var startAngle = 0;
      var paths = data.map(function(segment) {
        var endAngle = startAngle + percentageToAngle(segment.percentage);
        var path = describeArc(16, 16, 16, startAngle, endAngle);
        startAngle = endAngle;
        return `<path d="${path}" fill="${segment.color}"/>`;
      }).join("");

      var svg = `
        <svg width="${size}" height="${size}" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          ${paths}
          <circle cx="16" cy="16" r="10" fill="white"/>
          <text x="16" y="21" font-size="10" text-anchor="middle" fill="#000">${text}</text>
        </svg>`;
      var url = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svg)));
      return new L.Icon({
        iconUrl: url,
        iconSize: [size, size],
        iconAnchor: [size / 2, size / 2],
        popupAnchor: [0, -size / 2]
      });
    }

    function createColoredIcon(color, width, height, text) {
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');

      ctx.fillStyle = color;
      ctx.fillRect(0, 0, width, height);
      ctx.lineWidth = 3;
      ctx.strokeStyle = 'black';
      ctx.strokeRect(0, 0, width, height);

      ctx.font = '16px Arial';
      ctx.fillStyle = 'black';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      ctx.fillText(text, width / 2, height / 2);

      return L.icon({
        iconUrl: canvas.toDataURL(),
        iconSize: [width, height],
        iconAnchor: [width / 2, height / 2]
      });
    }

    class classSensor {
      constructor(name, color, width, height, lat, lng, text, number) {
        this.name = name;
        this.color = color;
        this.width = width;
        this.height = height;
        this.lat = lat;
        this.lng = lng;
        this.text = text;
        this.number = number;
        this.icon = createColoredIcon(color, width, height, text);
        this.marker = L.marker([lat, lng], { icon: this.icon, zIndexOffset: 100 }).addTo(map);
        this.marker.bindPopup(`<b>${this.name}</b>`);
        this.marker.on('click', () => this.showPopup());
        this.marker.on('mouseover', () => this.showNumberPopup());
        this.marker.on('mouseout', () => this.hideNumberPopup());
      }

      updateColor(newColor) {
        this.color = newColor;
        this.icon = createColoredIcon(this.color, this.width, this.height, this.text);
        this.marker.setIcon(this.icon);
      }

      showPopup() {
        const popupContent = `<canvas id="${this.name}-canvas" class="popupCanvas"></canvas>`;
        this.marker.bindPopup(popupContent).openPopup();
        this.drawCurve(`${this.name}-canvas`);
      }

      showNumberPopup() {
        if (this.marker.options.opacity === 1) {
          this.marker.bindPopup(`<b>${this.number}</b>`).openPopup();
        } else {
          console.log(`Marker ${this.name} is not visible.`);
        }
      }

      hideNumberPopup() {
        this.marker.closePopup();
      }

      drawCurve(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (canvas.getContext) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          canvas.width = 300;
          canvas.height = 150;
          ctx.beginPath();
          ctx.moveTo(10, 140);
          ctx.bezierCurveTo(20, 10, 280, 10, 290, 140);
          ctx.stroke();
          ctx.font = "16px Arial";
          ctx.fillText(this.text, 10, 20);
        }
      }

      hideMarker() {
        this.marker.setOpacity(0);
        this.marker.unbindPopup();
      }

      showMarker() {
        this.marker.setOpacity(1);
        this.marker.bindPopup(`<b>${this.name}</b>`);
      }
    }

    function updateVisibleMarkers() {
      var visibleMarkers = markerArray.filter(function(marker) {
        return map.getBounds().contains(marker.getLatLng());
      });

      console.log('Visible Markers:', visibleMarkers.map(marker => marker.options.name));

      zoomLevel = (map.getZoom() === 20.5);
      const arrayLength = markerArray.length;

      if (zoomLevel) {
        const schoolPass = visibleMarkers.length === 1 ? visibleMarkers[0].options.name : null;
        schoolSelection = schoolPass === 'Chicago Jesuit Academy' ? 1 : schoolPass === 'School 2' ? 2 : null;

        if (schoolSelection !== null) {
          createTopCanvasButtons(schoolSelection);
        }

        for (let i = 0; i < arrayLength; i++) {
          markerArray[i].setOpacity(0);
          markerArray[i].closePopup();
          markerArray[i].unbindPopup();
        }
        showCanvas('topCanvas');
        showCanvas('bottomCanvas');
        defineAndDisplayRoomMarkers(schoolSelection, options.topOption);

        document.getElementById('top1').click();
        document.getElementById('btn3').click();
      } else {
        for (let i = 0; i < arrayLength; i++) {
          markerArray[i].setOpacity(1);
          markerArray[i].bindPopup(`<b>${markerArray[i].options.name}</b>`);
        }
        hideCanvas('topCanvas');
        hideCanvas('bottomCanvas');
        clearRoomMarkers();
      }
    }

    function defineAndDisplayRoomMarkers(school, floor) {
      clearRoomMarkers();

      const bottomOption = activeBottomButtonText;
      console.log('1111' + school);
      console.log('222' + floor);
      console.log('3333' + bottomOption);
//      if(school && floor && bottomOption){
        const valueArray = SetValueArray(school, floor, bottomOption);
        console.log('*****' + valueArray);
//      }
      if (school === 1) {
        if (floor === 'Ground') {
          addRoomMarker('Room 111', 'red', 40, 40, 41.877425, -87.75188, 'G14', valueArray[0]);
          addRoomMarker('Room 112', 'green', 180, 32, 41.8772905, -87.7517385, 'Admin Hall', valueArray[1]);
          addRoomMarker('Room 113', 'yellow', 165, 200, 41.87721, -87.75148, 'G26', valueArray[2]);
          addRoomMarker('Room 114', 'green', 140, 240, 41.8771875, -87.751719, 'G33', valueArray[3]);
        } else if (floor === 'First') {
          addRoomMarker('Room 121', 'green', 120, 95, 41.87721, -87.75238, '115', valueArray[0]);
          addRoomMarker('Room 122', 'green', 110, 100, 41.877435, -87.751698, '134', valueArray[1]);
          addRoomMarker('Room 123', 'green', 110, 100, 41.877435, -87.751588, '135', valueArray[2]);
          addRoomMarker('Room 124', 'yellow', 110, 100, 41.877435, -87.75148, '136', valueArray[3]);
          addRoomMarker('Room 125', 'red', 110, 100, 41.877311, -87.751842, '137', valueArray[4]);
          addRoomMarker('Room 126', 'grey', 110, 100, 41.877311, -87.751735, '138', valueArray[5]);
          addRoomMarker('Room 127', 'green', 125, 110, 41.87725, -87.75146, '141', valueArray[6]);
          addRoomMarker('Room 128', 'green', 100, 75, 41.877241, -87.751612, '142', valueArray[7]);
          addRoomMarker('Room 129', 'red', 275, 380, 41.877081, -87.75153, '143', valueArray[8]);              
        } else if (floor === 'Second') {
          addRoomMarker('Room 131', 'grey', 110, 100, 41.87721, -87.75225, '210', valueArray[0]);
          addRoomMarker('Room 132', 'green', 110, 100, 41.877435, -87.751698, '231', valueArray[1]);
          addRoomMarker('Room 133', 'green', 110, 100, 41.877435, -87.751588, '232', valueArray[2]);
          addRoomMarker('Room 134', 'yellow', 110, 100, 41.877435, -87.75148, '233', valueArray[3]);
          addRoomMarker('Room 135', 'yellow', 110, 100, 41.877311, -87.751815, '234', valueArray[4]);
          addRoomMarker('Room 136', 'red', 110, 100, 41.877311, -87.751708, '235', valueArray[5]);
          addRoomMarker('Room 137', 'red', 110, 100, 41.877311, -87.75149, '236', valueArray[6]);
        }
      } else if (school === 2) {
        if (floor === 'Floor1') {
          addRoomMarker('Room 211', 'red', 110, 100, 43.07315, -89.40125, '001', valueArray[0]);
          addRoomMarker('Room 212', 'green', 110, 100, 43.07308, -89.40112, '002', valueArray[1]);
        } else if (floor === 'Floor2') {
          addRoomMarker('Room 221', 'yellow', 110, 100, 43.07305, -89.40128, '003', valueArray[0]);
          addRoomMarker('Room 222', 'grey', 110, 100, 43.07314, -89.40124, '004', valueArray[1]);
        }
      }
    }

    function addRoomMarker(name, color, width, height, lat, lng, text, number) {
      var roomMarker = new classSensor(name, color, width, height, lat, lng, text, number);
      roomMarkers.push(roomMarker);
    }

    function clearRoomMarkers() {
      roomMarkers.forEach(function(roomMarker) {
        map.removeLayer(roomMarker.marker);
      });
      roomMarkers = [];
    }

    function updateMarkerColors(colorArray) {
      var visibleMarkers = roomMarkers.filter(function(room) {
        return room.marker.options.opacity === 1;
      });

      visibleMarkers.forEach(function(room, index) {
        if (index < colorArray.length) {
          room.updateColor(colorArray[index]);
        }
      });
    }

    function onOptionChange(prop, value) {
      console.log(`The ${prop} was changed to ${value}`);
      if (prop === 'topOption') {
        defineAndDisplayRoomMarkers(schoolSelection, value);
      } else if (prop === 'bottomOption') {
        defineAndDisplayRoomMarkers(schoolSelection, options.topOption);
      }
    }

    function initMap() {
      var options = {
        center: [43.0731, -89.4012],
        zoom: 8
      };

      map = L.map('map', options);

      var googleLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 20.5,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: 'Map data &copy; Google'
      }).addTo(map);

      var pieData1 = [
        { color: '#FF0000', percentage: 30 },
        { color: '#00FF00', percentage: 50 }
      ];

      var pieData2 = [
        { color: '#0000FF', percentage: 40 },
        { color: '#FFFF00', percentage: 50 }
      ];

      const marker1 = L.marker([41.877331, -87.751678], { icon: createPiechartIcon(pieData1, 70, "20"), name: "Chicago Jesuit Academy", zIndexOffset: 1000 }).addTo(map);
      marker1.bindPopup("<b>Chicago Jesuit Academy</b>");
      markerArray.push(marker1);

      const marker2 = L.marker([43.0731, -89.4012], { icon: createPiechartIcon(pieData2, 70, "4"), name: "School 2", zIndexOffset: 1000 }).addTo(map);
      marker2.bindPopup("<b>School 2</b>");
      markerArray.push(marker2);

      markerArray.forEach(function(marker) {
        marker.on('mouseover', function() {
          if (this.options.opacity === 1) {
            this.openPopup();
          } else {
            console.log(`Marker ${this.options.name} is not visible.`);
          }
        });

        marker.on('mouseout', function() {
          this.closePopup();
        });
      });

      map.on('moveend', function() {
        updateVisibleMarkers();
      });

      map.on('zoomend', function() {
        updateVisibleMarkers();
      });

      updateVisibleMarkers();

      activateButton(document.getElementById('btn3').parentElement.querySelector('.button'), 'bottomCanvas');
    }

    function hideCanvas(canvasId) {
      var canvas = document.getElementById(canvasId);
      if (canvas) {
        canvas.style.display = 'none';
      } else {
        console.error('Canvas with ID ' + canvasId + ' not found.');
      }
    }

    function showCanvas(canvasId) {
      var canvas = document.getElementById(canvasId);
      if (canvas) {
        canvas.style.display = 'flex';
        if (canvasId === 'bottomCanvas') {
          canvas.style.flexDirection = 'column';
        }
      } else {
        console.error('Canvas with ID ' + canvasId + ' not found.');
      }
    }

    document.getElementById('topCanvas').addEventListener('click', function(event) {
      if (event.target && event.target.matches('.buttonTop')) {
        clearRoomMarkers();
        activateButton(event.target, 'topCanvas');
      }
    });

    document.getElementById('bottomCanvas').addEventListener('click', function(event) {
      if (event.target && event.target.matches('.buttonBottom')) {
        activateButton(event.target, 'bottomCanvas');
      }
    });

    document.addEventListener('DOMContentLoaded', initMap);
  </script>
  <script src="scriptfile.js"></script>
</body>
</html>
