<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Project</title>
  <link rel="stylesheet" href="stylefile.css">
  <link rel="stylesheet" href="chart.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <script src="rooms.js"></script>

  <style>
    /* Ensure map container takes up the full viewport height */
    #map {
      width: 100%;
      height: 100vh;
      position: relative;
    }

    /* Align the layer control icon next to the zoom control icon */
    .leaflet-top .leaflet-control {
      margin-top: 10px;
    }

    .leaflet-left .leaflet-control-layers {
      margin-left: 5px; /* Adjust this value to position correctly next to zoom controls */
    }

    .explanation {
      position: fixed;
      bottom: 0px;
      right: 0px;
      background-color: white;
      padding: 10px;
      border: 1px solid #ccc;
      z-index: 1000; /* Ensure the explanation is above the map */
      display: inline-block;
      max-width: 300px;
      touch-action: none;
    }

    .legend {
      background: white;
      padding: 5px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      font-size: 14px;
      line-height: 1.4em;
      color: #555;
    }
    .legend h4 {
      margin: 0;
      font-weight: bold;
      font-size: 16px;
      text-align: center;
    }
    .legend div {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }
    .legend span {
      display: inline-block;
      width: 18px;
      height: 18px;
      margin-right: 5px;
    }

    @media (max-height: 550px) {
      .explanation {
        padding: 5px;
        font-size: 30px;
      }
      .legend {
        font-size: 8px;
      }
      .legend h4 {
        font-size: 8px;
      }
      .legend span {
        width: 8px;
        height: 8px;
      }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="explanation" id="explanation" aria-live="polite">Explanation goes here</div>

  <div id="topCanvas"></div>
  <div id="returnCanvas">
    <div class="buttonContainer">
      <button id="returnButton" class="buttonTop">Reset</button>
    </div>
  </div>
  <div id="canvasContainer4">
    <div id="canvas4">
      <div class="top-buttons">
        <div class="button-container">
          <button class="chart-parameter" id="button41"></button>
          <span class="label">CO2</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button42"></button>
          <span class="label">PM2.5</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button43"></button>
          <span class="label">Dew Point</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button44"></button>
          <span class="label">TVOC</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button45"></button>
          <span class="label">TEMP</span>
        </div>
        <div class="button-container">
          <button class="chart-parameter" id="button46"></button>
          <span class="label">RH</span>
        </div>
      </div>
      <canvas id="curveCanvas" width="800" height="400"></canvas>
      <div class="chart-buttons">
        <div class="button-container">
          <button class="chart-date" id="hour"></button>
          <span class="label">Hour</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="day"></button>
          <span class="label">Day</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="week"></button>
          <span class="label">Week</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="month"></button>
          <span class="label">Month</span>
        </div>
        <div class="button-container">
          <button class="chart-date" id="year"></button>
          <span class="label">Year</span>
        </div>
      </div>
    </div>
    <div id="buttonContainer">
      <div id="closeButton">Return to Map</div>
      <div id="getCSVButton">Get CSV</div>
    </div>
  </div>
  <div id="bottomCanvas">
    <div class="bottomButtonContainer">
      <button id="btn1" class="button buttonBottom"></button><span class="bottomButtonText">CO2</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn2" class="button buttonBottom"></button><span class="bottomButtonText">PM2.5</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn3" class="button buttonBottom"></button><span class="bottomButtonText">Dew Point</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn4" class="button buttonBottom"></button><span class="bottomButtonText">TVOC</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn5" class="button buttonBottom"></button><span class="bottomButtonText">Temperature</span>
    </div>
    <div class="bottomButtonContainer">
      <button id="btn6" class="button buttonBottom"></button><span class="bottomButtonText">Relative Humidity</span>
    </div>
  </div>
  <div id="overlay"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY"></script>

  <script>
    let chart;
    const buttonIdToLabelMap = {
      'button41': 'CO2 (ppm)',
      'button42': 'PM2.5 (µg/m\u00B3)',
      'button43': 'Dew Point (\u00B0F)',
      'button44': 'TVOC (µg/m\u00B3)',
      'button45': 'TEMP (\u00B0F)',
      'button46': 'RH (%)'
    };

    function setActiveParameter(button) {
      document.querySelectorAll('.chart-parameter').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      activeChartParameter = button.id;
      console.log('Active parameter set to:', activeChartParameter);
      drawCurve();
    }

    function setActiveDate(button) {
      document.querySelectorAll('.chart-date').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      activeChartDate = button.id;
      console.log('Active date set to:', activeChartDate);
      drawCurve();
    }

    function updateVisibleMarkers() {
      var visibleMarkers = markerArray.filter(function (marker) {
        return map.getBounds().contains(marker.getLatLng());
      });

      console.log('Visible Markers:', visibleMarkers.map(marker => marker.options.name));

      var zoomLevel = map.getZoom() >= 18;
      const arrayLength = markerArray.length;

      if (zoomLevel) {
        var schoolPass = null;
        if (visibleMarkers.length === 1) {
          schoolPass = visibleMarkers[0].options.name;
        }

        if (schoolPass === 'Chicago Jesuit Academy') {
          schoolSelection = 1;
        } else if (schoolPass === 'School 2') {
          schoolSelection = 2;
        } else if (schoolPass === 'Quarra Stone') {
          schoolSelection = 3;
        }
        else {
          schoolSelection = null;
        }

        if (schoolSelection !== null) {
          createTopCanvasButtons(schoolSelection);
        }

        for (let i = 0; i < arrayLength; i++) {
          markerArray[i].setOpacity(0);
          markerArray[i].closePopup();
          markerArray[i].unbindPopup();
        }
        showCanvas('topCanvas');
        showCanvas('bottomCanvas');
        showCanvas('explanation');
        defineAndDisplayRoomMarkers(schoolSelection, options.topOption);

        var firstTopButton = document.querySelector('#topCanvas .buttonTop');
        if (firstTopButton) {
          firstTopButton.click();
        }

        var thirdBottomButton = document.querySelectorAll('#bottomCanvas .buttonBottom')[2];
        if (thirdBottomButton) {
          thirdBottomButton.click();
        }
      } else {
        for (let i = 0; i < arrayLength; i++) {
          markerArray[i].setOpacity(1);
          markerArray[i].bindPopup(`<b>${markerArray[i].options.name}</b>`);
        }
        hideCanvas('topCanvas');
        hideCanvas('bottomCanvas');
        hideCanvas('explanation');
        clearRoomMarkers();
      }
    }

    function clearRoomMarkers() {
      roomMarkers.forEach(function (roomMarker) {
        map.removeLayer(roomMarker.marker);
      });
      roomMarkers = [];
    }

    function updateMarkerColors(colorArray) {
      var visibleMarkers = roomMarkers.filter(function (room) {
        return room.marker.options.opacity === 1;
      });

      visibleMarkers.forEach(function (room, index) {
        if (index < colorArray.length) {
          room.updateColor(colorArray[index]);
        }
      });
    }

    function onOptionChange(prop, value) {
      console.log(`The ${prop} was changed to ${value}`);
      if (prop === 'topOption') {
        defineAndDisplayRoomMarkers(schoolSelection, value, activeBottomButtonText);
      } else if (prop === 'bottomOption') {
        defineAndDisplayRoomMarkers(schoolSelection, options.topOption, activeBottomButtonText);
      }
    }

    var manuMax = 19.5; // Replace this with your desired maximum zoom level for small viewports

    function setMaxZoom() {
      var viewportHeight = window.innerHeight;
      currentMaxZoom = viewportHeight < 550 ? manuMax : 19.5; // Update global variable
      console.log("Maximum Zoom Level:", currentMaxZoom);
      return currentMaxZoom;
    }

    function initMap() {
      var options = {
        center: initialMapCenter,
        zoom: initialMapZoom,
        maxZoom: setMaxZoom(), // Initialize maxZoom
        zoomDelta: 2,
        wheelPxPerZoomLevel: 50,
        scrollWheelZoom: false, // Disable scroll wheel zoom initially
        dragging: false,        // Disable dragging initially
        touchZoom: false,       // Disable touch zoom initially
        doubleClickZoom: false  // Disable double-click zoom initially
      };

      map = L.map('map', options);

      // Define the road map layer
      var roadMapLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 19.5,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: 'Map data &copy; Google'
      }).addTo(map); // Add road map layer as default

      // Define the satellite map layer
      var satelliteMapLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 19.5,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: 'Map data &copy; Google'
      });

      // Layer control for switching between road map and satellite view
      var baseMaps = {
        "Road Map": roadMapLayer,
        "Satellite View": satelliteMapLayer
      };

      var layerControl = L.control.layers(baseMaps, null, {
        position: 'topleft' // Set the position to 'topleft'
      }).addTo(map);

      var pieData1 = [
        { color: '#FF0000', percentage: 30 },
        { color: '#00FF00', percentage: 50 }
      ];

      var pieData2 = [
        { color: '#0000FF', percentage: 40 },
        { color: '#FFFF00', percentage: 50 }
      ];

      var pieData3 = [
        { color: 'red', percentage: 40 },
        { color: '#FFFF00', percentage: 50 }
      ];

      const marker1 = L.marker([41.877331, -87.751678], { icon: createPiechartIcon(pieData1, 40, "20"), name: "Chicago Jesuit Academy", zIndexOffset: 1000 }).addTo(map);
      marker1.bindPopup("<b>Chicago Jesuit Academy</b>");
      markerArray.push(marker1);

      marker1.on('click', function (e) {
        var lng = e.latlng.lng;
        var lat = e.latlng.lat;
        onMarkerClick(lat, lng);
      });

      const marker2 = L.marker([43.0731, -89.4012], { icon: createPiechartIcon(pieData2, 40, "4"), name: "School 2", zIndexOffset: 1000 }).addTo(map);
      marker2.bindPopup("<b>School 2</b>");
      markerArray.push(marker2);

      marker2.on('click', function (e) {
        var lng = e.latlng.lng;
        var lat = e.latlng.lat;
        onMarkerClick(lat, lng);
      });

      const marker3 = L.marker([43.2084038, -89.1974613], { icon: createPiechartIcon(pieData3, 40, "8"), name: "Quarra Stone", zIndexOffset: 1000 }).addTo(map);
      marker3.bindPopup("<b>Quarra Stone</b>");
      markerArray.push(marker3);

      marker3.on('click', function (e) {
        var lng = e.latlng.lng;
        var lat = e.latlng.lat;
        onMarkerClick(lat, lng);
      });      

      markerArray.forEach(function (marker) {
        marker.on('mouseover', function () {
          if (this.options.opacity === 1) {
            this.openPopup();
          }
        });

        marker.on('mouseout', function () {
          this.closePopup();
        });
      });

      map.on('moveend', function () {
        updateVisibleMarkers();
      });

      map.on('zoomend', function () {
        updateVisibleMarkers();
        if (map.getZoom() >= 19.5) {
          layerControl._container.style.pointerEvents = 'none'; // Disable layer control
          layerControl._container.style.opacity = '0.5'; // Dim layer control for visual feedback
        } else {
          layerControl._container.style.pointerEvents = 'auto'; // Enable layer control
          layerControl._container.style.opacity = '1'; // Restore layer control opacity
        }
      });

      map.on('load', function () {
        map.scrollWheelZoom.enable();
        map.dragging.enable();
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
      });

      map.whenReady(function () {
        map.scrollWheelZoom.enable();
        map.dragging.enable();
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
      });

      updateVisibleMarkers();

      activateButton(document.getElementById('btn3').parentElement.querySelector('.button'), 'bottomCanvas');

      document.getElementById('returnButton').addEventListener('click', returnToInitialMapView);

      // Call updateExplanation with the initial option
      updateExplanation('option1');
    }

    function hideCanvas(canvasId) {
      var canvas = document.getElementById(canvasId);
      if (canvas) {
        canvas.style.display = 'none';
      }
    }

    function showCanvas(canvasId) {
      var canvas = document.getElementById(canvasId);
      if (canvas) {
        canvas.style.display = 'flex';
        if (canvasId === 'bottomCanvas') {
          canvas.style.flexDirection = 'column';
        }
      }
    }

    document.getElementById('topCanvas').addEventListener('click', function (event) {
      if (event.target && event.target.matches('.buttonTop')) {
        clearRoomMarkers();
        activateButton(event.target, 'topCanvas');
      }
    });

    document.getElementById('bottomCanvas').addEventListener('click', function (event) {
      if (event.target && event.target.matches('.buttonBottom')) {
        activateButton(event.target, 'bottomCanvas');
      }
    });

    document.addEventListener('DOMContentLoaded', initMap);

    function onMarkerClick(lat, lng) {
      console.log("Marker clicked at latitude:", lat, "and longitude:", lng);
      map.setView([lat, lng], map.getMaxZoom() - 2); // Adjust zoom to maxZoom
    }

    function hideCanvas4() {
      document.getElementById('canvasContainer4').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    document.getElementById('closeButton').onclick = hideCanvas4;

    document.getElementById('getCSVButton').addEventListener('click', generateAndDownloadCSV);

    function generateAndDownloadCSV() {
      // Define your data
      const data = array13;
      // Convert data array to CSV string
      const csvContent = data.map(e => e.join(",")).join("\n");

      // Create a blob from the CSV string
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

      // Create a link element
      const link = document.createElement("a");
      if (link.download !== undefined) {
          // Create a URL for the blob and set it as the href attribute
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", "data.csv");
          
          // Append link to the body and trigger the download
          document.body.appendChild(link);
          link.click();
          
          // Clean up and remove the link
          document.body.removeChild(link);
      }
    }



// Function to update the explanation based on the option variable
function updateExplanation(option) {
  var explanationText;
  switch (option) {
    case 'option1':
      explanationText = `
        <div class="legend">
          <h4>Carbon Dioxide (ppm)</h4>
          <div><span style="background-color: #00ff00;"></span> < 1000 Typical</div>
          <div><span style="background-color: #ffff00;"></span> 1000 - 2000 Moderate</div>
          <div><span style="background-color: #ff0000;"></span> > 2000 High</div>
          <div><span style="background-color: #000000;"></span> Connection Lost</div>
          <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
        </div>`;
      break;
    case 'option2':
    explanationText = `
        <div class="legend">
          <h4>Particulate Matter 2.5 (ug/m<sup>3</sup>)</h4>
          <div><span style="background-color: #00ff00;"></span> < 19 Typical</div>
          <div><span style="background-color: #ffff00;"></span> 19 - 250 Moderate</div>
          <div><span style="background-color: #ff0000;"></span> > 250 High</div>
          <div><span style="background-color: #000000;"></span> Connection Lost</div>
          <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
        </div>`;
      break;
    case 'option3':
    explanationText = `
        <div class="legend">
          <h4>Dew Point (\u00B0F)</h4>
          <div><span style="background-color: #00ff00;"></span> < 55 Typical</div>
          <div><span style="background-color: #ffff00;"></span> 55-60 Elevated</div>
          <div><span style="background-color: #ff0000;"></span> > 60 High</div>
          <div><span style="background-color: #000000;"></span> Connection Lost</div>
          <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
        </div>`;
      break;
    case 'option4':
    explanationText = `
        <div class="legend">
          <h4>TVOC (ug/m<sup>3</sup>)</h4>
          <div><span style="background-color: #00ff00;"></span> < 1 Good</div>
          <div><span style="background-color: #ffff00;"></span> 1 - 10 Elevated</div>
          <div><span style="background-color: #ff0000;"></span> > 10 High</div>
          <div><span style="background-color: #000000;"></span> Connection Lost</div>
          <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
        </div>`;
      break;
    case 'option5':
    explanationText = `
        <div class="legend">
          <h4>Temperature (\u00B0F>)</h4>
          <div><span style="background-color: #00ff00;"></span> < 65-81 Typical</div>
          <div><span style="background-color: #ffff00;"></span> 55-65 Slightly Low</div>
          <div><span style="background-color: #ffff00;"></span> 81-90 Slightly High</div>
          <div><span style="background-color: #ff0000;"></span> > 90 High</div>
          <div><span style="background-color: #ff0000;"></span> < 55 Low</div>
          <div><span style="background-color: #000000;"></span> Connection Lost</div>
          <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
        </div>`;
      break;
    case 'option6':
    explanationText = `
        <div class="legend">
          <h4>Relative Humidity (%)</h4>
          <div><span style="background-color: #00ff00;"></span> < 30-60 Typical</div>
          <div><span style="background-color: #ffff00;"></span> 20-30 Slightly Low</div>
          <div><span style="background-color: #ffff00;"></span> 60-80 Slightly High</div>
          <div><span style="background-color: #ff0000;"></span> > 80 High</div>
          <div><span style="background-color: #ff0000;"></span> < 20 Low</div>
          <div><span style="background-color: #000000;"></span> Connection Lost</div>
          <div><span style="background-color: #808080;"></span> Room with No Sensor</div>
        </div>`;
      break;
    default:
      explanationText = 'Default explanation.';
  }
  var explanationDiv = document.getElementById('explanation');
  if (explanationDiv) {
    explanationDiv.innerHTML = explanationText;
    console.log("Explanation updated: ", explanationText);
  } else {
    console.error("Explanation div not found");
  }
}

// Adding event listeners to buttons
document.getElementById('btn1').addEventListener('click', function() {
  updateExplanation('option1');
});
document.getElementById('btn2').addEventListener('click', function() {
  updateExplanation('option2');
});
document.getElementById('btn3').addEventListener('click', function() {
  updateExplanation('option3');
});
document.getElementById('btn4').addEventListener('click', function() {
  updateExplanation('option4');
});
document.getElementById('btn5').addEventListener('click', function() {
  updateExplanation('option5');
});
document.getElementById('btn6').addEventListener('click', function() {
  updateExplanation('option6');
});

// Simulate a click on btn3 when the page loads
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('btn3').click();
});

    

    // Adding event listeners to prevent zooming in the explanation area
    const explanation = document.getElementById('explanation');
    explanation.addEventListener('wheel', function (event) {
      event.preventDefault();
    });
    explanation.addEventListener('touchmove', function (event) {
      event.preventDefault();
    });    
    

    function logCurrentState() {
      legendOption = activeChartParameter;
      console.log('%%%%%' + legendOption)
      console.log("schoolSelection:", schoolSelection);
      console.log("!!!!activeChartParameter:", activeChartParameter);
      console.log("!!!!activeChartDate:", activeChartDate);
      console.log("activeChartDate:", activeChartDate);
      console.log("options.topOption:", options.topOption);
      console.log("activeRoomName:", activeRoomName);
      console.log("currentMaxZoom:", currentMaxZoom); // Log the current maximum zoom level
    }

//    setInterval(logCurrentState, 5000);

  </script>
  <script src="scriptfile.js"></script>
  <script src="scriptGenerate.js"></script>
  <script src="curve.js"></script>
</body>
</html>

